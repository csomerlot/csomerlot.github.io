<!--
Automatically generated HTML file from DocOnce source
(https://github.com/hplgit/doconce/)
-->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="DocOnce: https://github.com/hplgit/doconce/" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="description" content="Computer Projects">

<title>Computer Projects</title>

<!-- Bootstrap style: bootstrap_blue -->
<link href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.rawgit.com/hplgit/doconce/master/bundled/html_styles/style_bootstrap/css/bootstrap_blue.css" rel="stylesheet">
<!-- not necessary
<link href="https://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
-->

<style type="text/css">

/* Add scrollbar to dropdown menus in bootstrap navigation bar */
.dropdown-menu {
   height: auto;
   max-height: 400px;
   overflow-x: hidden;
}

/* Adds an invisible element before each target to offset for the navigation
   bar */
.anchor::before {
  content:"";
  display:block;
  height:50px;      /* fixed header height for style bootstrap_blue */
  margin:-50px 0 0; /* negative fixed header height */
}
</style>


</head>

<!-- tocinfo
{'highest level': 1,
 'sections': [('Table of contents',
               1,
               'table_of_contents',
               'table_of_contents'),
              ('Robotics Club Setup', 1, None, '___sec0'),
              ('Home Internet Gateway', 1, None, '___sec1'),
              ('Arduino Wind Instrument', 1, None, '___sec2'),
              ('Motocomms', 1, None, '___sec3'),
              ('Track GDD', 1, None, '___sec4'),
              ('Tartan designer', 1, None, '___sec5'),
              ('Somerlot Shooting Support System (S4)', 1, None, '___sec6'),
              ('Retail support tools', 1, None, '___sec7'),
              ('Scheduler', 2, None, '___sec8'),
              ('Rewards Program Calculator', 2, None, '___sec9'),
              ('Common Mobile Compute Platform', 1, None, '___sec10'),
              ('Domotics', 1, None, '___sec11'),
              ('Automotive Media System', 1, None, '___sec12'),
              ('GPS Chartplotter', 1, None, '___sec13'),
              ('Common Sensor and Datalogger Platform', 1, None, '___sec14'),
              ('Micro Hydroponics', 1, None, '___sec15'),
              ('Technology as Art', 1, None, '___sec16'),
              ('Wood Burning Plotter', 2, None, '___sec17'),
              ('Lightning Catcher', 2, None, '___sec18'),
              ('Irrigation Remote', 1, None, '___sec19'),
              ('The Best Damn Radio System', 1, None, '___sec20'),
              ('Fixed Wing UAV', 1, None, '___sec21'),
              ('Autonomous Underwater Vehicle', 1, None, '___sec22'),
              ('Pool Octobot', 1, None, '___sec23'),
              ('Scarecrow Targeting System', 1, None, '___sec24'),
              ('Invasive Species Patroller', 1, None, '___sec25'),
              ('Signal-Tracking Antenna Mount', 1, None, '___sec26'),
              ('CAM Maker Frame', 1, None, '___sec27')]}
end of tocinfo -->

<body>

    
<!-- Bootstrap navigation bar -->
<div class="navbar navbar-default navbar-fixed-top">
  <div class="navbar-header">
    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-responsive-collapse">
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
    <a class="navbar-brand" href="ComputerProjects.html">Computer Projects</a>
  </div>

  <div class="navbar-collapse collapse navbar-responsive-collapse">
    <ul class="nav navbar-nav navbar-right">
      <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Contents <b class="caret"></b></a>
        <ul class="dropdown-menu">
     <!-- navigation toc: --> <li><a href="ComputerProjects020.html#table_of_contents" style="font-size: 80%;"><b>Table of contents</b></a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects001.html#___sec0" style="font-size: 80%;"><b>Robotics Club Setup</b></a></li>
     <!-- navigation toc: --> <li><a href="#___sec1" style="font-size: 80%;"><b>Home Internet Gateway</b></a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects003.html#___sec2" style="font-size: 80%;"><b>Arduino Wind Instrument</b></a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects004.html#___sec3" style="font-size: 80%;"><b>Motocomms</b></a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects005.html#___sec4" style="font-size: 80%;"><b>Track GDD</b></a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects006.html#___sec5" style="font-size: 80%;"><b>Tartan designer</b></a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects007.html#___sec6" style="font-size: 80%;"><b>Somerlot Shooting Support System (S4)</b></a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects008.html#___sec7" style="font-size: 80%;"><b>Retail support tools</b></a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects008.html#___sec8" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;Scheduler</a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects008.html#___sec9" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;Rewards Program Calculator</a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects010.html#___sec10" style="font-size: 80%;"><b>Common Mobile Compute Platform</b></a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects011.html#___sec11" style="font-size: 80%;"><b>Domotics</b></a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects012.html#___sec12" style="font-size: 80%;"><b>Automotive Media System</b></a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects013.html#___sec13" style="font-size: 80%;"><b>GPS Chartplotter</b></a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects014.html#___sec14" style="font-size: 80%;"><b>Common Sensor and Datalogger Platform</b></a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects015.html#___sec15" style="font-size: 80%;"><b>Micro Hydroponics</b></a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects016.html#___sec16" style="font-size: 80%;"><b>Technology as Art</b></a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects016.html#___sec17" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;Wood Burning Plotter</a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects016.html#___sec18" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;Lightning Catcher</a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects017.html#___sec19" style="font-size: 80%;"><b>Irrigation Remote</b></a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects018.html#___sec20" style="font-size: 80%;"><b>The Best Damn Radio System</b></a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects021.html#___sec21" style="font-size: 80%;"><b>Fixed Wing UAV</b></a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects022.html#___sec22" style="font-size: 80%;"><b>Autonomous Underwater Vehicle</b></a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects023.html#___sec23" style="font-size: 80%;"><b>Pool Octobot</b></a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects024.html#___sec24" style="font-size: 80%;"><b>Scarecrow Targeting System</b></a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects025.html#___sec25" style="font-size: 80%;"><b>Invasive Species Patroller</b></a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects025.html#___sec26" style="font-size: 80%;"><b>Signal-Tracking Antenna Mount</b></a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects025.html#___sec27" style="font-size: 80%;"><b>CAM Maker Frame</b></a></li>

        </ul>
      </li>
    </ul>
  </div>
</div>
</div> <!-- end of navigation bar -->

<div class="container">

<p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p> <!-- add vertical space -->

<a name="part0002"></a>
<!-- !split -->

<h1 id="___sec1" class="anchor">Home Internet Gateway </h1>
<b>Description:</b>
Cable modem, IoT gateway, wifi router/repeater, and firewall device.

<p>
<b>User Story:</b>
I just want the internet to work. I also want to protect my family and house, integrate with Domotics and IoT, and give the internet company their crap hardware back. Maybe I can even eventually dump the internet company completely for community-based wifi or a free-space optical link.

<p>
<b>Feature Set:</b>

<ol>
<li> Parental Filtering and logging</li>
<li> Directional Wifi</li>
<li> Switching between internet sources</li>
<li> Performance and health dashboard</li>
<li> wikipedia and media cache</li>
<li> privacy and ad blocking</li>
<li> <a href="https://othernet.is/" target="_self">Othernet</a> Integration (I <em>so</em> hope this project works)</li>
<li> <a href="https://github.com/IRNAS/FSO-systems" target="_self">FSO link</a></li>
</ol>

<b>Phasing:</b>

<ul>
<li> configure basic access point (check functionality after each step)</li>

<ul>
  <li> Basic config shown <a href="https://www.raspberrypi.org/documentation/configuration/wireless/access-point-routed.md" target="_self">here</a> (first part only) including security (but not ufw firewall) set up shown <a href="https://www.raspberrypi.org/documentation/configuration/security.md" target="_self">here</a></li>

<ul>
    <li> Use wlan1 instead of on-board wlan0</li>
    <li> Enable <a href="https://lb.raspberrypi.org/forums/viewtopic.php?t=92859" target="_self">hostapd</a> and <a href="https://www.linux.com/tutorials/advanced-dnsmasq-tips-and-tricks/" target="_self">dnsmasq</a> logging</li>
    <li> Open network via hostapd conf shown <a href="https://elinux.org/RPI-Wireless-Hotspot" target="_self">here</a></li>
</ul>

  <li> <a href="https://serverfault.com/questions/214996/iptables-allow-ssh-access-only-nothing-else-in-or-out" target="_self">mod iptables to allow ssh in only</a></li>

<ul>
    <li> check with nmap -sS -p 1-65535 <external ip></li>
    <li> set up sshd with <a href="https://www.cyberciti.biz/tips/linux-unix-bsd-openssh-server-best-practices.html" target="_self">best practices</a></li>
</ul>

  <li> create a log of sites visited by MAC address</li>

<ul>
    <li> set up tcpdump to save link headers to <a href="https://www.raspberrypi.org/forums/viewtopic.php?t=237584" target="_self">MySQL</a> (see code below)</li>
    <li> The better option is to use a <a href="https://www.dinofizzotti.com/blog/2019-01-09-running-a-man-in-the-middle-proxy-on-a-raspberry-pi-3/" target="_self">MITM proxy</a> in transparent mode, but that requires users accepting and installing a certificate</li>
    <li> use <a href="https://dash-gallery.plotly.host/dash-oil-and-gas/" target="_self">dash</a> to create BI reports of traffic</li>
    <li> link with <a href="https://code.wireshark.org/review/gitweb?p=wireshark.git;a=blob_plain;f=manuf" target="_self">MAC dbs</a> and commonly-used domains DB</li>
</ul>

  <li> set up <a href="https://aws.amazon.com/blogs/startups/how-to-build-a-serverless-dynamic-dns-system-with-aws/" target="_self">Dynamic DNS</a> (see code below)</li>
  <li> set up a DNS Sinkhole such as <a href="https://en.wikipedia.org/wiki/Pi-hole" target="_self">pi-hole</a> or <a href="https://github.com/quidsup/notrack" target="_self">NoTrack</a> to cut down on ads</li>
  <li> use OpenDNS to cut down on phishing and increase DNS lookup speeds (<a href="https://www.raspberrypi.org/forums/viewtopic.php?t=210933" target="_self">Has to be set up in dnsmasq using option 6</a>)</li>
  <li> set up <a href="https://learn.adafruit.com/onion-pi?view=all" target="_self">tor</a> or a VPN</li>
  <li> set up config landing page</li>

<ul>
    <li> Switch choice of wlan0 or eth0</li>
    <li> Tune filters, dyndns, dns sink</li>
    <li> Show dash traffic metrics</li>
    <li> Show status metrics (by user)</li>
</ul>

</ul>

<li> swap cable modem</li>
<li> add external storage with media library</li>
<li> install othernet</li>
<li> build FSO tranceivers</li>

<ul>
  <li> <a href="https://www.adafruit.com/product/1056" target="_self">Laser</a> transmitter coupled to a <a href="https://www.adafruit.com/product/2831" target="_self">photo transister</a> receiver mounted on a <a href="https://www.amazon.com/BARSKA-15-40x50-Colorado-Spotting-Scope/dp/B0049IZMUW/ref=sr_1_16?dchild=1&keywords=spotting+scope&qid=1578058031&sr=8-16" target="_self">spotting scope</a>, with fiber optic modulators</li>
</ul>

</ul>

<b>BOM:</b>

<ol>
<li> <a href="/ComputerProjects010.html#___sec10" target="_self">Common Mobile Compute Platform</a> (two, one for testing, one for production)</li>
</ol>

<b>Notes:</b>

<ul>
<li> <a href="https://www.digikey.com/en/articles/techzone/2013/oct/building-free-space-optical-systems" target="_self"><tt>https://www.digikey.com/en/articles/techzone/2013/oct/building-free-space-optical-systems</tt></a></li>
<li> <a href="http://shop.oreilly.com/product/9780596002046.do" target="_self"><tt>http://shop.oreilly.com/product/9780596002046.do</tt></a></li>
</ul>

<b>GRAPHICS:</b>

<p>
<center> <!-- figure label: --> <div id="fig:los"></div> <!-- FIGURE -->
<hr class="figure">
<center><p class="caption">Figure 1:  Line of sight between office and home.  <!-- caption label: fig:los --> </p></center>
<p><img src="https://raw.githubusercontent.com/csomerlot/csomerlot.github.io/master/./Programming/AP_Viewshed.jpg" align="bottom" width=600></p>
</center>

<p>
<b>CODE:</b>
<p>

<!-- code=python (!bc pypro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><span style="color: #3D7B7B; font-style: italic">### This script updates Route53 AWS Cloud service with the DNS record for the public IP</span>


<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">boto3</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">socket</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">netifaces</span>

public_ip <span style="color: #666666">=</span> ni<span style="color: #666666">.</span>ifaddresses(<span style="color: #BA2121">&#39;eth0&#39;</span>)[AF_INET][<span style="color: #666666">0</span>][<span style="color: #BA2121">&#39;addr&#39;</span>]
<span style="color: #008000">print</span>(public_ip)

<span style="color: #3D7B7B; font-style: italic">#https://github.com/awslabs/route53-dynamic-dns-with-lambda/blob/master/v1/dynamic_dns_lambda.py</span>
client <span style="color: #666666">=</span> boto3<span style="color: #666666">.</span>client(<span style="color: #BA2121">&#39;route53&#39;</span> )
route_53_zone_id     <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;&#39;</span> <span style="color: #3D7B7B; font-style: italic"># your zone ID here</span>
route_53_record_name <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;&#39;</span> <span style="color: #3D7B7B; font-style: italic"># your FQDN here</span>
route_53_record_type <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;A&#39;</span>
route_53_record_ttl  <span style="color: #666666">=</span> <span style="color: #666666">300</span>

response <span style="color: #666666">=</span> client<span style="color: #666666">.</span>change_resource_record_sets(
            HostedZoneId<span style="color: #666666">=</span>route_53_zone_id,
            ChangeBatch<span style="color: #666666">=</span>{
                <span style="color: #BA2121">&#39;Changes&#39;</span>: [
                    {
                        <span style="color: #BA2121">&#39;Action&#39;</span>: <span style="color: #BA2121">&#39;UPSERT&#39;</span>,
                        <span style="color: #BA2121">&#39;ResourceRecordSet&#39;</span>: {
                            <span style="color: #BA2121">&#39;Name&#39;</span>: route_53_record_name,
                            <span style="color: #BA2121">&#39;Type&#39;</span>: route_53_record_type,
                            <span style="color: #BA2121">&#39;TTL&#39;</span>: route_53_record_ttl,
                            <span style="color: #BA2121">&#39;ResourceRecords&#39;</span>: [
                                {
                                    <span style="color: #BA2121">&#39;Value&#39;</span>: public_ip
                                }
                            ]
                        }
                    }
                ]
            }
        )
<span style="color: #008000">print</span>(response)
</pre></div>
<p>
<b>CODE:</b>
<p>

<!-- code=python (!bc pypro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">socket</span><span style="color: #666666">,</span> <span style="color: #0000FF; font-weight: bold">sys</span><span style="color: #666666">,</span> <span style="color: #0000FF; font-weight: bold">os</span><span style="color: #666666">,</span> <span style="color: #0000FF; font-weight: bold">time</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">subprocess</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">sub</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">log</span>(message):
    <span style="color: #008000">print</span>(message)

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">csvInit</span>():
    <span style="color: #008000; font-weight: bold">with</span> <span style="color: #008000">open</span>(<span style="color: #19177C">__file__</span><span style="color: #666666">.</span>replace(<span style="color: #BA2121">&quot;.py&quot;</span>, <span style="color: #BA2121">&quot;.csv&quot;</span>), <span style="color: #BA2121">&#39;w&#39;</span>, encoding<span style="color: #666666">=</span><span style="color: #BA2121">&#39;utf-8&#39;</span>, newline<span style="color: #666666">=</span><span style="color: #BA2121">&#39;</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&#39;</span>) <span style="color: #008000; font-weight: bold">as</span> csvf:
        csvf<span style="color: #666666">.</span>write(<span style="color: #BA2121">&quot;datetime,path,size</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span>)

    <span style="color: #008000; font-weight: bold">return</span> csvf<span style="color: #666666">.</span>name

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">csvInsert</span>(fname, data):
    <span style="color: #008000; font-weight: bold">with</span> <span style="color: #008000">open</span>(fname, <span style="color: #BA2121">&#39;a&#39;</span>, encoding<span style="color: #666666">=</span><span style="color: #BA2121">&#39;utf-8&#39;</span>, newline<span style="color: #666666">=</span><span style="color: #BA2121">&#39;</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&#39;</span>) <span style="color: #008000; font-weight: bold">as</span> csvf:
        <span style="color: #008000; font-weight: bold">for</span> row <span style="color: #AA22FF; font-weight: bold">in</span> data:
            csvf<span style="color: #666666">.</span>write(<span style="color: #BA2121">&quot;</span><span style="color: #A45A77; font-weight: bold">{}</span><span style="color: #BA2121">,</span><span style="color: #A45A77; font-weight: bold">{}</span><span style="color: #BA2121">,</span><span style="color: #A45A77; font-weight: bold">{}</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>format(time<span style="color: #666666">.</span>strftime(<span style="color: #BA2121">&quot;%m/</span><span style="color: #A45A77; font-weight: bold">%d</span><span style="color: #BA2121">/%Y %H:%M&quot;</span>, time<span style="color: #666666">.</span>localtime()), row, data[row]))

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">dbInit</span>():
    <span style="color: #3D7B7B; font-style: italic">## https://enterprise-docs.anaconda.com/en/latest/data-science-workflows/data/mariadb.html</span>
    <span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">mysql.connector</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">mariadb</span>
    <span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">json</span>

    <span style="color: #3D7B7B; font-style: italic">## take care to configure security correctly:</span>
    <span style="color: #3D7B7B; font-style: italic">#### https://stackoverflow.com/questions/1559955/host-xxx-xx-xxx-xxx-is-not-allowed-to-connect-to-this-mysql-server</span>
    <span style="color: #3D7B7B; font-style: italic">#### https://mariadb.com/kb/en/configuring-mariadb-for-remote-client-access/</span>
    <span style="color: #3D7B7B; font-style: italic">## Now, read the credentials from secret</span>
    credentials <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>
    <span style="color: #008000; font-weight: bold">with</span> <span style="color: #008000">open</span>(<span style="color: #19177C">__file__</span><span style="color: #666666">.</span>replace(<span style="color: #BA2121">&quot;.py&quot;</span>, <span style="color: #BA2121">&quot;.jsn&quot;</span>)) <span style="color: #008000; font-weight: bold">as</span> f:
        credentials <span style="color: #666666">=</span> json<span style="color: #666666">.</span>load(f)

    <span style="color: #3D7B7B; font-style: italic"># Ensure your credentials were setup</span>
    <span style="color: #008000; font-weight: bold">if</span> credentials:
        <span style="color: #3D7B7B; font-style: italic"># Connect to the DB</span>
        connection <span style="color: #666666">=</span> mariadb<span style="color: #666666">.</span>connect(
            user<span style="color: #666666">=</span>credentials<span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;user&#39;</span>),
            password<span style="color: #666666">=</span>credentials<span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;password&#39;</span>),
            database<span style="color: #666666">=</span>credentials<span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;database&#39;</span>),
            host<span style="color: #666666">=</span>credentials<span style="color: #666666">.</span>get(<span style="color: #BA2121">&#39;host&#39;</span>)
        )
        cursor <span style="color: #666666">=</span> connection<span style="color: #666666">.</span>cursor()

        <span style="color: #3D7B7B; font-style: italic"># Execute the query</span>
        cursor<span style="color: #666666">.</span>execute(<span style="color: #BA2121">&quot;CREATE TABLE IF NOT EXISTS activity (</span><span style="color: #AA5D1F; font-weight: bold">\</span>
<span style="color: #BA2121">            date DATE,  hour TINYINT, minute TINYINT, second TINYINT, </span><span style="color: #AA5D1F; font-weight: bold">\</span>
<span style="color: #BA2121">            len INT UNSIGNED NOT NULL, </span><span style="color: #AA5D1F; font-weight: bold">\</span>
<span style="color: #BA2121">            fromAddress NVARCHAR(255) NOT NULL, fromPort NVARCHAR (50), fromContext NVARCHAR (50),</span><span style="color: #AA5D1F; font-weight: bold">\</span>
<span style="color: #BA2121">            toAddress NVARCHAR(255) NOT NULL, toPort NVARCHAR (50), toContext NVARCHAR (50)</span><span style="color: #AA5D1F; font-weight: bold">\</span>
<span style="color: #BA2121">            );&quot;</span>)

        <span style="color: #008000; font-weight: bold">return</span> connection

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">dbInsert</span>(dbconn, data):
    cursor <span style="color: #666666">=</span> dbconn<span style="color: #666666">.</span>cursor()
    insertStr <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;INSERT INTO activity VALUES &quot;</span>
    now <span style="color: #666666">=</span> time<span style="color: #666666">.</span>localtime()

    <span style="color: #008000; font-weight: bold">for</span> path <span style="color: #AA22FF; font-weight: bold">in</span> data:
        insertStr <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;(&#39;</span><span style="color: #A45A77; font-weight: bold">{}</span><span style="color: #BA2121">&#39;,</span><span style="color: #A45A77; font-weight: bold">{}</span><span style="color: #BA2121">,</span><span style="color: #A45A77; font-weight: bold">{}</span><span style="color: #BA2121">,</span><span style="color: #A45A77; font-weight: bold">{}</span><span style="color: #BA2121">,</span><span style="color: #A45A77; font-weight: bold">{}</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>format(time<span style="color: #666666">.</span>strftime(<span style="color: #BA2121">&quot;%Y-%m-</span><span style="color: #A45A77; font-weight: bold">%d</span><span style="color: #BA2121">&quot;</span>, now), now[<span style="color: #666666">3</span>], now[<span style="color: #666666">4</span>], now[<span style="color: #666666">5</span>], data[path])
        <span style="color: #008000; font-weight: bold">for</span> pp <span style="color: #AA22FF; font-weight: bold">in</span> parsePath(path):
            insertStr <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;,&#39;</span><span style="color: #A45A77; font-weight: bold">{}</span><span style="color: #BA2121">&#39;&quot;</span><span style="color: #666666">.</span>format(pp)
        insertStr <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;), &quot;</span>
    insertStr <span style="color: #666666">=</span> insertStr[:<span style="color: #666666">-2</span>] <span style="color: #666666">+</span> <span style="color: #BA2121">&#39;;&#39;</span>

    cursor<span style="color: #666666">.</span>execute(insertStr)
    dbconn<span style="color: #666666">.</span>commit()

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">parsePath</span>(path):
    _from, _to <span style="color: #666666">=</span> path<span style="color: #666666">.</span>strip()<span style="color: #666666">.</span>split(<span style="color: #BA2121">&quot; &gt; &quot;</span>)
    _fromPort <span style="color: #666666">=</span> _from<span style="color: #666666">.</span>split(<span style="color: #BA2121">&quot;.&quot;</span>)[<span style="color: #666666">-1</span>]
    _fromAdd <span style="color: #666666">=</span> _from[:<span style="color: #666666">-1*</span>(<span style="color: #008000">len</span>(_fromPort)<span style="color: #666666">+1</span>)]
    _fromContext <span style="color: #666666">=</span> domainLookup(_fromAdd)
    _toPort <span style="color: #666666">=</span> _to<span style="color: #666666">.</span>split(<span style="color: #BA2121">&quot;.&quot;</span>)[<span style="color: #666666">-1</span>]
    _toAdd <span style="color: #666666">=</span> _to[:<span style="color: #666666">-1*</span>(<span style="color: #008000">len</span>(_toPort)<span style="color: #666666">+1</span>)]
    _toContext <span style="color: #666666">=</span> domainLookup(_toAdd)

    <span style="color: #008000; font-weight: bold">return</span> _fromAdd, _fromPort, _fromContext, _toAdd, _toPort, _toContext

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">domainLookup</span>(address):
    <span style="color: #008000; font-weight: bold">if</span> address <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;BCBRWN-PF0QMJMY&#39;</span> <span style="color: #AA22FF; font-weight: bold">or</span> address<span style="color: #666666">.</span>replace(<span style="color: #BA2121">&quot;.&quot;</span>,<span style="color: #BA2121">&quot;&quot;</span>)<span style="color: #666666">.</span>isdigit(): context <span style="color: #666666">=</span> address
    <span style="color: #008000; font-weight: bold">elif</span> address<span style="color: #666666">.</span>endswith(<span style="color: #BA2121">&#39;1e100.net&#39;</span>): context <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;gmail&quot;</span>
    <span style="color: #008000; font-weight: bold">elif</span> address<span style="color: #666666">.</span>startswith(<span style="color: #BA2121">&quot;iRobot&quot;</span>): context <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;Roomba&quot;</span>
    <span style="color: #008000; font-weight: bold">elif</span> address<span style="color: #666666">.</span>startswith(<span style="color: #BA2121">&quot;instagram&quot;</span>): context <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;instagram&quot;</span>
    <span style="color: #008000; font-weight: bold">elif</span> address<span style="color: #666666">.</span>endswith(<span style="color: #BA2121">&quot;.com&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> address<span style="color: #666666">.</span>endswith(<span style="color: #BA2121">&quot;.net&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> address<span style="color: #666666">.</span>endswith(<span style="color: #BA2121">&quot;.org&quot;</span>):
        context <span style="color: #666666">=</span> address<span style="color: #666666">.</span>split(<span style="color: #BA2121">&quot;.&quot;</span>)[<span style="color: #666666">-2</span>]
    <span style="color: #008000; font-weight: bold">else</span>: context <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;&quot;</span>
    <span style="color: #008000; font-weight: bold">return</span> context

<span style="color: #008000; font-weight: bold">if</span> <span style="color: #19177C">__name__</span> <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;__main__&#39;</span>:
    <span style="color: #3D7B7B; font-style: italic">## simplest use is &#39;nohup python3 watcher.py &amp;&#39;, but making it a systemctl service is better: https://www.raspberrypi.org/documentation/linux/usage/systemd.md</span>

    <span style="color: #3D7B7B; font-style: italic"># datastore = csvInit()</span>
    <span style="color: #3D7B7B; font-style: italic"># saveData = csvInsert</span>
    <span style="color: #3D7B7B; font-style: italic"># or</span>
    datastore <span style="color: #666666">=</span> dbInit()
    saveData <span style="color: #666666">=</span> dbInsert

    timeIndex <span style="color: #666666">=</span> <span style="color: #666666">4</span> <span style="color: #3D7B7B; font-style: italic">## index of the struct_time; 5 for sum by second, 4 for sum data by minute, 3 for sum by hour</span>

    lastmin <span style="color: #666666">=</span> time<span style="color: #666666">.</span>localtime()[timeIndex]
    db <span style="color: #666666">=</span> {}

    <span style="color: #3D7B7B; font-style: italic">## run tcpdump in buffer mode, link headers only</span>
    p <span style="color: #666666">=</span> sub<span style="color: #666666">.</span>Popen((<span style="color: #BA2121">&#39;sudo&#39;</span>, <span style="color: #BA2121">&#39;tcpdump&#39;</span>, <span style="color: #BA2121">&#39;-q&#39;</span>, <span style="color: #BA2121">&#39;-i&#39;</span>, <span style="color: #BA2121">&#39;wlan1&#39;</span>, <span style="color: #BA2121">&#39;-le&#39;</span>, <span style="color: #BA2121">&#39;greater 55 and tcp&#39;</span>), stdout<span style="color: #666666">=</span>sub<span style="color: #666666">.</span>PIPE)
    <span style="color: #008000; font-weight: bold">for</span> row <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">iter</span>(p<span style="color: #666666">.</span>stdout<span style="color: #666666">.</span>readline, <span style="color: #BA2121">b&#39;&#39;</span>):

    <span style="color: #3D7B7B; font-style: italic">## or use a test file for debugging</span>
    <span style="color: #3D7B7B; font-style: italic"># with open(&#39;test.log&#39;, &#39;rb&#39;) as f: testlog = f.readlines()</span>
    <span style="color: #3D7B7B; font-style: italic"># for row in testlog:</span>

        <span style="color: #008000; font-weight: bold">try</span>:
            mainParts <span style="color: #666666">=</span>  row<span style="color: #666666">.</span>decode(<span style="color: #BA2121">&#39;utf-8&#39;</span>)<span style="color: #666666">.</span>strip()<span style="color: #666666">.</span>split(<span style="color: #BA2121">&#39;,&#39;</span>)
            nextParts <span style="color: #666666">=</span> mainParts[<span style="color: #666666">2</span>]<span style="color: #666666">.</span>split(<span style="color: #BA2121">&#39;:&#39;</span>)
            path <span style="color: #666666">=</span> nextParts[<span style="color: #666666">1</span>]
            length <span style="color: #666666">=</span> <span style="color: #008000">int</span>(nextParts[<span style="color: #666666">0</span>][<span style="color: #666666">7</span>:])
            <span style="color: #008000; font-weight: bold">if</span> path <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #AA22FF; font-weight: bold">in</span> db: db[path] <span style="color: #666666">=</span> <span style="color: #666666">0</span>
            db[path]<span style="color: #666666">+=</span> length

            <span style="color: #008000; font-weight: bold">if</span> lastmin <span style="color: #666666">!=</span> time<span style="color: #666666">.</span>localtime()[timeIndex]:
                saveData(datastore, db)
                db <span style="color: #666666">=</span> {}
                lastmin <span style="color: #666666">=</span> time<span style="color: #666666">.</span>localtime()[timeIndex]

        <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">ValueError</span>:
            log(<span style="color: #BA2121">&quot;Bad row: </span><span style="color: #A45A77; font-weight: bold">{}</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>format(row<span style="color: #666666">.</span>strip()))
</pre></div>
<p>
<p>
<!-- navigation buttons at the bottom of the page -->
<ul class="pager">

  <li class="previous">
    <a href="ComputerProjects001.html">&larr; Prev</a>
  </li>

  <li class="next">
    <a href="ComputerProjects003.html">Next &rarr;</a>
  </li>
</ul>
<!-- ------------------- end of main content --------------- -->

</div>  <!-- end container -->
<!-- include javascript, jQuery *first* -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>

<!-- Bootstrap footer
<footer>
<a href="http://..."><img width="250" align=right src="http://..."></a>
</footer>
-->


<center style="font-size:80%">
<!-- copyright only on the titlepage -->
</center>


</body>
</html>
    

