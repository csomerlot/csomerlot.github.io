<!--
Automatically generated HTML file from DocOnce source
(https://github.com/hplgit/doconce/)
-->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="DocOnce: https://github.com/hplgit/doconce/" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="description" content="Internet-of-Things Projects">

<title>Internet-of-Things Projects</title>

<!-- Bootstrap style: bootstrap_blue -->
<link href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.rawgit.com/hplgit/doconce/master/bundled/html_styles/style_bootstrap/css/bootstrap_blue.css" rel="stylesheet">
<!-- not necessary
<link href="https://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
-->

<style type="text/css">

/* Add scrollbar to dropdown menus in bootstrap navigation bar */
.dropdown-menu {
   height: auto;
   max-height: 400px;
   overflow-x: hidden;
}

/* Adds an invisible element before each target to offset for the navigation
   bar */
.anchor::before {
  content:"";
  display:block;
  height:50px;      /* fixed header height for style bootstrap_blue */
  margin:-50px 0 0; /* negative fixed header height */
}
</style>


</head>

<!-- tocinfo
{'highest level': 1,
 'sections': [('Table of contents',
               1,
               'table_of_contents',
               'table_of_contents'),
              ('Common Mobile Compute Platform', 1, None, '___sec0'),
              ('Domotics', 1, None, '___sec1'),
              ('Automotive Media System', 1, None, '___sec2'),
              ('GPS Chartplotter', 1, None, '___sec3'),
              ('Common Sensor and Datalogger Platform', 1, None, '___sec4'),
              ('Micro Hydroponics', 1, None, '___sec5'),
              ('Technology as Art', 1, None, '___sec6'),
              ('Wood Burning Plotter', 2, None, '___sec7'),
              ('Lightning Catcher', 2, None, '___sec8'),
              ('Irrigation Remote', 1, None, '___sec9'),
              ('The Best Damn Radio System', 1, None, '___sec10')]}
end of tocinfo -->

<body>

    
<!-- Bootstrap navigation bar -->
<div class="navbar navbar-default navbar-fixed-top">
  <div class="navbar-header">
    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-responsive-collapse">
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
    <a class="navbar-brand" href="IoTProjects.html">Internet-of-Things Projects</a>
  </div>

  <div class="navbar-collapse collapse navbar-responsive-collapse">
    <ul class="nav navbar-nav navbar-right">
      <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Contents <b class="caret"></b></a>
        <ul class="dropdown-menu">
     <!-- navigation toc: --> <li><a href="IoTProjects000.html#table_of_contents" style="font-size: 80%;"><b>Table of contents</b></a></li>
     <!-- navigation toc: --> <li><a href="IoTProjects001.html#___sec0" style="font-size: 80%;"><b>Common Mobile Compute Platform</b></a></li>
     <!-- navigation toc: --> <li><a href="IoTProjects002.html#___sec1" style="font-size: 80%;"><b>Domotics</b></a></li>
     <!-- navigation toc: --> <li><a href="IoTProjects003.html#___sec2" style="font-size: 80%;"><b>Automotive Media System</b></a></li>
     <!-- navigation toc: --> <li><a href="IoTProjects004.html#___sec3" style="font-size: 80%;"><b>GPS Chartplotter</b></a></li>
     <!-- navigation toc: --> <li><a href="IoTProjects005.html#___sec4" style="font-size: 80%;"><b>Common Sensor and Datalogger Platform</b></a></li>
     <!-- navigation toc: --> <li><a href="#___sec5" style="font-size: 80%;"><b>Micro Hydroponics</b></a></li>
     <!-- navigation toc: --> <li><a href="IoTProjects007.html#___sec6" style="font-size: 80%;"><b>Technology as Art</b></a></li>
     <!-- navigation toc: --> <li><a href="IoTProjects007.html#___sec7" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;Wood Burning Plotter</a></li>
     <!-- navigation toc: --> <li><a href="IoTProjects007.html#___sec8" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;Lightning Catcher</a></li>
     <!-- navigation toc: --> <li><a href="IoTProjects008.html#___sec9" style="font-size: 80%;"><b>Irrigation Remote</b></a></li>
     <!-- navigation toc: --> <li><a href="IoTProjects009.html#___sec10" style="font-size: 80%;"><b>The Best Damn Radio System</b></a></li>

        </ul>
      </li>
    </ul>
  </div>
</div>
</div> <!-- end of navigation bar -->

<div class="container">

<p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p> <!-- add vertical space -->

<a name="part0006"></a>
<!-- !split -->

<h1 id="___sec5" class="anchor">Micro Hydroponics </h1>
<b>Description:</b>
Small air pump-based flood irrigation system for office plants

<p>
<b>User Story:</b>
Offices are great places for plants, with ample windows and beneficial effects for workers. But, regular watering can be an issue.

<p>
<b>Feature Set:</b>

<ol>
<li> Flood-based system of irrigation with emergency overflow

<ol type="a"></li>
   <li> Air pump inflates bladder, raises solution level, opens ARV to deflate and drop level</li>
   <li> 16" max head = 0.6 PSI</li>
</ol>

<li> Planting cells to allow co-planting but easy replacement/management

<ol type="a"></li>
   <li> Pre-made rock wool blocks available locally</li>
</ol>

<li> 14 day hands-off and quiet operation

<ol type="a"></li>
   <li> Water uptake/usage increases air volume needed to achieve same fluid level, requiring level sensors</li>
</ol>

<li> Water level and quality sensors, media moisture for SmartUtility demonstration via dashboard

<ol type="a"></li>
   <li> Water and energy usage, solution level and nutrient strength</li>
   <li> Back-calculate media moisture based on the timing of flooding and the drain-back volume?</li>
</ol>

<li> Low voltage and redundant level sensor

<ol type="a"></li>
   <li> Pressure sensor for full range and eTape for top 12"</li>
</ol>

<li> Attractive as office decor</li>
</ol>

<b>Phasing:</b>

<ol>
<li> Build sensor and ARV mechanicals

<ol type="a"></li>
   <li> Mount tape and air feed and pressure feed to stick, with ARV and pressure sensor at top</li>
   <li> Assemble and encase feather near power supply</li>
</ol>

<li> Install base controller logic</li>
<li> Build server script that runs flood routine based on MQTT events</li>
<li> Build flood tank with rock wool planting cells</li>
<li> triple-tote system:

<ol type="a"></li>
   <li> Media tray</li>

<ol>
       <li> Notches in bottom edge for drainage</li>
       <li> Anchoring for rock wool cubes

<ol type="a"></li>
           <li> brass screws along rim, to strech rubber bands over?</li>
</ol>

</ol>

   <li> Solution tank</li>

<ol>
       <li> Air line running into 1 large ballon

<ol type="a"></li>
         <li> multiple balloons make multiple points of failure, plus don't inflate equally</li>
</ol>

       <li> Latch media tray in place to avoid flotation</li>
       <li> Thru-hole for overflow port</li>
</ol>

   <li> Overflow tank</li>

<ol>
       <li> Captures leaks or overflows</li>
       <li> Removal with handle for general purpose use</li>
</ol>

</ol>

<li> Open-top cabinet on casters to hold everything and make pretty</li>
</ol>

<b>BOM:</b>

<ul>
<li> <a href="http://adafru.it/3619" target="_self">Adafruit ESP32 Feather</a></li>
<li> <a href="https://www.adafruit.com/product/464" target="_self">12in Chemical eTape Liquid Level Sensor</a></li>
<li> <a href="https://www.adafruit.com/product/4663" target="_self">Mini solenoid air valve</a></li>
<li> <a href="https://www.adafruit.com/product/2935" target="_self">Controllable Four Outlet Power Relay Module version 2</a></li>
<li> Separate 5v 1.5A power supply for solenoid and connectors to</li> 
<li> <a href="https://www.sunsethydro.com/collections/growing-media/products/grodan-delta-hugo-6in-block-6in-x-6in-x-6in-w-hole-individual-single-blocks" target="_self">growing media</a></li>
<li> <a href="https://www.truevalue.com/latch-carry-tote-clear-base-18-gallons" target="_self">totes</a></li>
<li> <a href="https://www.digikey.com/product-detail/en/nxp-usa-inc/MPVZ5004GW7U/MPVZ5004GW7U-ND/1168374" target="_self">MPVZ5004GW PRESSURE SENSOR by NXP</a></li>
<li> Silicone tubing</li>
</ul>

<b>Notes:</b>

<ul>
<li> <a href="https://learn.adafruit.com/home-automation-in-the-cloud-with-the-esp8266-and-adafruit-io/introduction" target="_self"><tt>https://learn.adafruit.com/home-automation-in-the-cloud-with-the-esp8266-and-adafruit-io/introduction</tt></a></li>
<li> Needs some type of anchoring for media in top container for replacing plants and rock wool easily</li>
<li> Flood chamber must be securely anchored against flotation</li>
<li> <a href="./PlantWaterer/PlantWaterer.html" target="_self">First iteration</a> of the design was a simple Trinket-based timer that controlled a <a href="https://www.adafruit.com/product/1150" target="_self">mini peristaltic pump</a>. It worked if the water source was elevated to deal with the limits of the pump curve.</li>
</ul>

<b>Logic:</b>

<ol>
<li> Server scheduling:

<ol type="a"></li>
   <li> Repeat Daily:</li>

<ol>
       <li> Fire client event</li>
       <li> If no completion signal in 60 minutes, report</li>
</ol>

</ol>

<li> Client event:

<ol type="a"></li>
   <li> turn on air pump and close air release valve for until level has stabilized to within 0.25" for 5 minutes</li>

<ol>
       <li> Report time to complete</li>
       <li> Repeat every 15 seconds: 

<ol type="a"></li>
           <li> report solution level from both sensors</li>
           <li> if it has been more than 20 minutes, terminate on cycle and alert</li>
</ol>

</ol>

   <li> if sensors do not agree on level, alert</li>
   <li> if solution level falls below 3", alert</li>
</ol>

</ol>

<b>CODE:</b>
<p>

<!-- code=c (!bc cpro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><span style="color: #3D7B7B; font-style: italic">/***************************************************</span>
<span style="color: #3D7B7B; font-style: italic">  Adapted primarily from:</span>
<span style="color: #3D7B7B; font-style: italic">  Adafruit ESP8266 onoffbutton Controller Module</span>

<span style="color: #3D7B7B; font-style: italic">  Must use ESP8266 Arduino from:</span>
<span style="color: #3D7B7B; font-style: italic">    https://github.com/esp8266/Arduino</span>
<span style="color: #3D7B7B; font-style: italic">  Works great with Adafruit&#39;s Huzzah ESP board:</span>
<span style="color: #3D7B7B; font-style: italic">  ----&gt; https://www.adafruit.com/product/2471</span>
<span style="color: #3D7B7B; font-style: italic">  Adafruit invests time and resources providing this open source code,</span>
<span style="color: #3D7B7B; font-style: italic">  please support Adafruit and open-source hardware by purchasing</span>
<span style="color: #3D7B7B; font-style: italic">  products from Adafruit!</span>
<span style="color: #3D7B7B; font-style: italic">  Written by Tony DiCola for Adafruit Industries.</span>
<span style="color: #3D7B7B; font-style: italic">  Adafruit IO example additions by Todd Treece.</span>
<span style="color: #3D7B7B; font-style: italic">  MIT license, all text above must be included in any redistribution</span>
<span style="color: #3D7B7B; font-style: italic"> ****************************************************/</span><span style="color: #bbbbbb"></span>

<span style="color: #9C6500">#include</span><span style="color: #bbbbbb"> </span><span style="color: #3D7B7B; font-style: italic">&lt;WiFi101.h&gt; // for Feather M0 ATWINC1500</span><span style="color: #9C6500"></span>
<span style="color: #3D7B7B; font-style: italic">//#include &lt;WiFi.h&gt; // for Feather HUZZAH32 ESP32</span>
<span style="color: #3D7B7B; font-style: italic">//#include &lt;ESP8266WiFi.h&gt;</span>
<span style="color: #9C6500">#include</span><span style="color: #bbbbbb"> </span><span style="color: #3D7B7B; font-style: italic">&quot;Adafruit_MQTT.h&quot;</span><span style="color: #9C6500"></span>
<span style="color: #9C6500">#include</span><span style="color: #bbbbbb"> </span><span style="color: #3D7B7B; font-style: italic">&quot;Adafruit_MQTT_Client.h&quot;</span><span style="color: #9C6500"></span>
<span style="color: #9C6500">#include</span><span style="color: #bbbbbb"> </span><span style="color: #3D7B7B; font-style: italic">&quot;keysandstuff.h&quot;</span><span style="color: #9C6500"></span>


<span style="color: #3D7B7B; font-style: italic">// onoffbutton pin</span>
<span style="color: #008000; font-weight: bold">const</span><span style="color: #bbbbbb"> </span><span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>switch_pin<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>;<span style="color: #bbbbbb"></span>

<span style="color: #3D7B7B; font-style: italic">// Functions</span>
<span style="color: #3D7B7B; font-style: italic">//void MQTT_connect();</span>

WiFiClient<span style="color: #bbbbbb"> </span>client;<span style="color: #bbbbbb"></span>

<span style="color: #3D7B7B; font-style: italic">// Setup the MQTT client class by passing in the WiFi client and MQTT server and login details.</span>
Adafruit_MQTT_Client<span style="color: #bbbbbb"> </span><span style="color: #0000FF">mqtt</span>(<span style="color: #666666">&amp;</span>client,<span style="color: #bbbbbb"> </span>AIO_SERVER,<span style="color: #bbbbbb"> </span>AIO_SERVERPORT,<span style="color: #bbbbbb"> </span>AIO_USERNAME,<span style="color: #bbbbbb"> </span>AIO_KEY);<span style="color: #bbbbbb"></span>

<span style="color: #3D7B7B; font-style: italic">/****************************** Feeds ***************************************/</span><span style="color: #bbbbbb"></span>

<span style="color: #3D7B7B; font-style: italic">// Setup a feed called &#39;onoffbutton&#39; for subscribing to changes.</span>
<span style="color: #3D7B7B; font-style: italic">// Notice MQTT paths for AIO follow the form: &lt;username&gt;/feeds/&lt;feedname&gt;</span>
Adafruit_MQTT_Subscribe<span style="color: #bbbbbb"> </span>onoffbutton<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>Adafruit_MQTT_Subscribe(<span style="color: #666666">&amp;</span>mqtt,<span style="color: #bbbbbb"> </span>AIO_USERNAME<span style="color: #bbbbbb"> </span><span style="color: #BA2121">&quot;/feeds/onoff&quot;</span>);<span style="color: #bbbbbb"></span>
Adafruit_MQTT_Publish<span style="color: #bbbbbb"> </span>onoff_get<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>Adafruit_MQTT_Publish(<span style="color: #666666">&amp;</span>mqtt,<span style="color: #bbbbbb"> </span>AIO_USERNAME<span style="color: #bbbbbb"> </span><span style="color: #BA2121">&quot;/feeds/onoff/get&quot;</span>);<span style="color: #bbbbbb"></span>

<span style="color: #3D7B7B; font-style: italic">// Setup feeds for sensors</span>
Adafruit_MQTT_Publish<span style="color: #bbbbbb"> </span>level_Pressure<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>Adafruit_MQTT_Publish(<span style="color: #666666">&amp;</span>mqtt,<span style="color: #bbbbbb"> </span>AIO_USERNAME<span style="color: #bbbbbb"> </span><span style="color: #BA2121">&quot;/feeds/level_pressure&quot;</span>);<span style="color: #bbbbbb"></span>
Adafruit_MQTT_Publish<span style="color: #bbbbbb"> </span>level_Tape<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>Adafruit_MQTT_Publish(<span style="color: #666666">&amp;</span>mqtt,<span style="color: #bbbbbb"> </span>AIO_USERNAME<span style="color: #bbbbbb"> </span><span style="color: #BA2121">&quot;/feeds/level_tape&quot;</span>);<span style="color: #bbbbbb"></span>

<span style="color: #3D7B7B; font-style: italic">/*************************** Sketch Code ************************************/</span><span style="color: #bbbbbb"></span>

<span style="color: #B00040">void</span><span style="color: #bbbbbb"> </span><span style="color: #0000FF">setup</span>()<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #3D7B7B; font-style: italic">//Configure pins for Adafruit ATWINC1500 Feather</span>
<span style="color: #bbbbbb">  </span>WiFi.setPins(<span style="color: #666666">8</span>,<span style="color: #666666">7</span>,<span style="color: #666666">4</span>,<span style="color: #666666">2</span>);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>
<span style="color: #bbbbbb">  </span>pinMode(switch_pin,<span style="color: #bbbbbb"> </span>OUTPUT);<span style="color: #bbbbbb"></span>

<span style="color: #bbbbbb">  </span>Serial.begin(<span style="color: #666666">115200</span>);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #008000; font-weight: bold">while</span><span style="color: #bbbbbb"> </span>(<span style="color: #666666">!</span>Serial)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"> </span>;<span style="color: #bbbbbb"> </span>}<span style="color: #bbbbbb"> </span><span style="color: #3D7B7B; font-style: italic">// wait for serial port to connect. Needed for debugging with serial monitor only</span>
<span style="color: #bbbbbb">  </span>
<span style="color: #bbbbbb">  </span>delay(<span style="color: #666666">10</span>);<span style="color: #bbbbbb"></span>

<span style="color: #bbbbbb">  </span><span style="color: #3D7B7B; font-style: italic">// Connect to WiFi access point.</span>
<span style="color: #bbbbbb">  </span>Serial.println();<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>Serial.println();<span style="color: #bbbbbb"></span>

<span style="color: #bbbbbb">  </span>Serial.print(<span style="color: #BA2121">&quot;Connecting to &quot;</span>);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>Serial.println(WLAN_SSID);<span style="color: #bbbbbb"></span>

<span style="color: #bbbbbb">  </span>WiFi.begin(WLAN_SSID,<span style="color: #bbbbbb"> </span>WLAN_PASS);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #008000; font-weight: bold">while</span><span style="color: #bbbbbb"> </span>(WiFi.status()<span style="color: #bbbbbb"> </span><span style="color: #666666">!=</span><span style="color: #bbbbbb"> </span>WL_CONNECTED)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>delay(<span style="color: #666666">500</span>);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>Serial.print(F(<span style="color: #BA2121">&quot;.&quot;</span>));<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>Serial.println();<span style="color: #bbbbbb"></span>

<span style="color: #bbbbbb">  </span>Serial.println(F(<span style="color: #BA2121">&quot;WiFi connected&quot;</span>));<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>Serial.println(F(<span style="color: #BA2121">&quot;IP address: &quot;</span>));<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>Serial.println(WiFi.localIP());<span style="color: #bbbbbb"></span>

<span style="color: #bbbbbb">  </span><span style="color: #3D7B7B; font-style: italic">// listen for events on the onoffbutton feed</span>
<span style="color: #bbbbbb">  </span>mqtt.subscribe(<span style="color: #666666">&amp;</span>onoffbutton);<span style="color: #bbbbbb"></span>

<span style="color: #bbbbbb">  </span><span style="color: #3D7B7B; font-style: italic">// connect to adafruit io</span>
<span style="color: #bbbbbb">  </span>MQTT_connect();<span style="color: #bbbbbb"></span>

}<span style="color: #bbbbbb"></span>

<span style="color: #B00040">void</span><span style="color: #bbbbbb"> </span><span style="color: #0000FF">loop</span>()<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #B00040">int8_t</span><span style="color: #bbbbbb"> </span>jobDuration;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>Adafruit_MQTT_Subscribe<span style="color: #bbbbbb"> </span><span style="color: #666666">*</span>subscription;<span style="color: #bbbbbb"></span>

<span style="color: #bbbbbb">  </span><span style="color: #3D7B7B; font-style: italic">// ping adafruit io a few times to make sure we remain connected</span>
<span style="color: #bbbbbb">  </span><span style="color: #008000; font-weight: bold">if</span>(<span style="color: #666666">!</span><span style="color: #bbbbbb"> </span>mqtt.ping(<span style="color: #666666">3</span>))<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #3D7B7B; font-style: italic">// reconnect to adafruit io</span>
<span style="color: #bbbbbb">    </span><span style="color: #008000; font-weight: bold">if</span>(<span style="color: #666666">!</span><span style="color: #bbbbbb"> </span>mqtt.connected())<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span>MQTT_connect();<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #3D7B7B; font-style: italic">//</span>
<span style="color: #bbbbbb">  </span>
<span style="color: #bbbbbb">  </span><span style="color: #3D7B7B; font-style: italic">// this is our &#39;wait for incoming subscription packets&#39; busy subloop</span>

<span style="color: #bbbbbb">  </span><span style="color: #008000; font-weight: bold">while</span><span style="color: #bbbbbb"> </span>(subscription<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>mqtt.readSubscription(<span style="color: #666666">1000</span>))<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>

<span style="color: #bbbbbb">    </span><span style="color: #008000; font-weight: bold">if</span><span style="color: #bbbbbb"> </span>(subscription<span style="color: #bbbbbb"> </span><span style="color: #666666">==</span><span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;</span>onoffbutton)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span>Serial.print(F(<span style="color: #BA2121">&quot;On-Off button: &quot;</span>));<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span>Serial.println((<span style="color: #B00040">char</span><span style="color: #bbbbbb"> </span><span style="color: #666666">*</span>)onoffbutton.lastread);<span style="color: #bbbbbb"></span>

<span style="color: #bbbbbb">      </span><span style="color: #3D7B7B; font-style: italic">// convert mqtt ascii payload to int</span>
<span style="color: #bbbbbb">      </span><span style="color: #B00040">char</span><span style="color: #bbbbbb"> </span><span style="color: #666666">*</span>value<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>(<span style="color: #B00040">char</span><span style="color: #bbbbbb"> </span><span style="color: #666666">*</span>)onoffbutton.lastread;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span>Serial.print(F(<span style="color: #BA2121">&quot;Received: &quot;</span>));<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span>Serial.println(value);<span style="color: #bbbbbb"></span>

<span style="color: #bbbbbb">      </span><span style="color: #3D7B7B; font-style: italic">// Apply message to onoffbutton</span>
<span style="color: #bbbbbb">      </span>String<span style="color: #bbbbbb"> </span>message<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>String(value);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span>message.trim();<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span><span style="color: #008000; font-weight: bold">if</span><span style="color: #bbbbbb"> </span>(message<span style="color: #bbbbbb"> </span><span style="color: #666666">==</span><span style="color: #bbbbbb"> </span><span style="color: #BA2121">&quot;ON&quot;</span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">        </span>jobDuration<span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>Flood();<span style="color: #bbbbbb">      </span>
<span style="color: #bbbbbb">        </span>Serial.println(<span style="color: #BA2121">&quot;publishing to /get&quot;</span>);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">        </span>onoff_get.publish((<span style="color: #B00040">int32_t</span>)jobDuration);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">        </span><span style="color: #008000; font-weight: bold">break</span>;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>}<span style="color: #bbbbbb"></span>
}<span style="color: #bbbbbb"></span>

<span style="color: #3D7B7B; font-style: italic">// connect to adafruit io via MQTT</span>

<span style="color: #B00040">void</span><span style="color: #bbbbbb"> </span><span style="color: #0000FF">MQTT_connect</span>()<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #B00040">int8_t</span><span style="color: #bbbbbb"> </span>ret;<span style="color: #bbbbbb"></span>

<span style="color: #bbbbbb">  </span><span style="color: #008000; font-weight: bold">while</span><span style="color: #bbbbbb"> </span>((ret<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>mqtt.connect())<span style="color: #bbbbbb"> </span><span style="color: #666666">!=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>

<span style="color: #bbbbbb">    </span><span style="color: #008000; font-weight: bold">switch</span><span style="color: #bbbbbb"> </span>(ret)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span><span style="color: #008000; font-weight: bold">case</span><span style="color: #bbbbbb"> </span><span style="color: #666666">1:</span><span style="color: #bbbbbb"> </span>Serial.println(F(<span style="color: #BA2121">&quot;Wrong protocol&quot;</span>));<span style="color: #bbbbbb"> </span><span style="color: #008000; font-weight: bold">break</span>;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span><span style="color: #008000; font-weight: bold">case</span><span style="color: #bbbbbb"> </span><span style="color: #666666">2:</span><span style="color: #bbbbbb"> </span>Serial.println(F(<span style="color: #BA2121">&quot;ID rejected&quot;</span>));<span style="color: #bbbbbb"> </span><span style="color: #008000; font-weight: bold">break</span>;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span><span style="color: #008000; font-weight: bold">case</span><span style="color: #bbbbbb"> </span><span style="color: #666666">3:</span><span style="color: #bbbbbb"> </span>Serial.println(F(<span style="color: #BA2121">&quot;Server unavail&quot;</span>));<span style="color: #bbbbbb"> </span><span style="color: #008000; font-weight: bold">break</span>;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span><span style="color: #008000; font-weight: bold">case</span><span style="color: #bbbbbb"> </span><span style="color: #666666">4:</span><span style="color: #bbbbbb"> </span>Serial.println(F(<span style="color: #BA2121">&quot;Bad user/pass&quot;</span>));<span style="color: #bbbbbb"> </span><span style="color: #008000; font-weight: bold">break</span>;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span><span style="color: #008000; font-weight: bold">case</span><span style="color: #bbbbbb"> </span><span style="color: #666666">5:</span><span style="color: #bbbbbb"> </span>Serial.println(F(<span style="color: #BA2121">&quot;Not authed&quot;</span>));<span style="color: #bbbbbb"> </span><span style="color: #008000; font-weight: bold">break</span>;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span><span style="color: #008000; font-weight: bold">case</span><span style="color: #bbbbbb"> </span><span style="color: #666666">6:</span><span style="color: #bbbbbb"> </span>Serial.println(F(<span style="color: #BA2121">&quot;Failed to subscribe&quot;</span>));<span style="color: #bbbbbb"> </span><span style="color: #008000; font-weight: bold">break</span>;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span><span style="color: #008000; font-weight: bold">default</span><span style="color: #666666">:</span><span style="color: #bbbbbb"> </span>Serial.println(F(<span style="color: #BA2121">&quot;Connection failed&quot;</span>));<span style="color: #bbbbbb"> </span><span style="color: #008000; font-weight: bold">break</span>;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>}<span style="color: #bbbbbb"></span>

<span style="color: #bbbbbb">    </span><span style="color: #008000; font-weight: bold">if</span>(ret<span style="color: #bbbbbb"> </span><span style="color: #666666">&gt;=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>)<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span>mqtt.disconnect();<span style="color: #bbbbbb"></span>

<span style="color: #bbbbbb">    </span>Serial.println(F(<span style="color: #BA2121">&quot;Retrying MQTT connection in 5 seconds...&quot;</span>));<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>delay(<span style="color: #666666">5000</span>);<span style="color: #bbbbbb"></span>

<span style="color: #bbbbbb">  </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>Serial.println(F(<span style="color: #BA2121">&quot;MQTT Connected to Adafruit IO!&quot;</span>));<span style="color: #bbbbbb"></span>

<span style="color: #bbbbbb">  </span><span style="color: #3D7B7B; font-style: italic">/*</span>
<span style="color: #3D7B7B; font-style: italic">  Publishing to {username}/feeds/onoff/get will trigger the last</span>
<span style="color: #3D7B7B; font-style: italic">  value to be resent. Putting this call inside the MQTT_connect</span>
<span style="color: #3D7B7B; font-style: italic">  function means that whenever MQTT reconnects, the latest value</span>
<span style="color: #3D7B7B; font-style: italic">  for the feed will be received almost immediately.</span>
<span style="color: #3D7B7B; font-style: italic">  */</span><span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>Serial.println(<span style="color: #BA2121">&quot;publishing to /get&quot;</span>);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>onoff_get.publish((<span style="color: #B00040">int32_t</span>)<span style="color: #666666">0</span>);<span style="color: #bbbbbb"></span>
}<span style="color: #bbbbbb"></span>

<span style="color: #B00040">int8_t</span><span style="color: #bbbbbb"> </span><span style="color: #0000FF">Flood</span>()<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>timer<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>;<span style="color: #bbbbbb"></span>

<span style="color: #bbbbbb">    </span><span style="color: #3D7B7B; font-style: italic">// turn on air pump and close ARV</span>
<span style="color: #bbbbbb">    </span>digitalWrite(switch_pin,<span style="color: #bbbbbb"> </span>LOW);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>
<span style="color: #bbbbbb">    </span><span style="color: #B00040">float</span><span style="color: #bbbbbb"> </span>level_pressure_data;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #B00040">float</span><span style="color: #bbbbbb"> </span>level_tape_data;<span style="color: #bbbbbb"></span>

<span style="color: #bbbbbb">    </span><span style="color: #B00040">float</span><span style="color: #bbbbbb"> </span>last_level_pressure_data<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #B00040">float</span><span style="color: #bbbbbb"> </span>last_level_tape_data<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #008000; font-weight: bold">while</span><span style="color: #bbbbbb"> </span>(<span style="color: #008000">true</span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">        </span>timer<span style="color: #bbbbbb"> </span><span style="color: #666666">+=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">3</span>;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">        </span>level_pressure_data<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">        </span>level_tape_data<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">        </span><span style="color: #008000; font-weight: bold">if</span><span style="color: #bbbbbb"> </span>(<span style="color: #666666">!</span><span style="color: #bbbbbb"> </span>level_Pressure.publish(level_pressure_data))<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">          </span>Serial.println(F(<span style="color: #BA2121">&quot;Failed to publish level_pressure&quot;</span>));<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">        </span><span style="color: #008000; font-weight: bold">else</span><span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">          </span>Serial.println(F(<span style="color: #BA2121">&quot;Level_pressure published!&quot;</span>));<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">         </span>
<span style="color: #bbbbbb">        </span><span style="color: #008000; font-weight: bold">if</span><span style="color: #bbbbbb"> </span>(<span style="color: #666666">!</span><span style="color: #bbbbbb"> </span>level_Tape.publish(level_tape_data))<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">          </span>Serial.println(F(<span style="color: #BA2121">&quot;Failed to publish level_tape&quot;</span>));<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">        </span><span style="color: #008000; font-weight: bold">else</span><span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">          </span>Serial.println(F(<span style="color: #BA2121">&quot;Level_tape published!&quot;</span>));<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">        </span>
<span style="color: #bbbbbb">        </span>last_level_pressure_data<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>level_pressure_data;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">        </span>last_level_tape_data<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>level_tape_data;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">        </span>
<span style="color: #bbbbbb">        </span><span style="color: #008000; font-weight: bold">if</span><span style="color: #bbbbbb"> </span>(abs(level_pressure_data<span style="color: #bbbbbb"> </span><span style="color: #666666">-</span><span style="color: #bbbbbb"> </span>level_tape_data)<span style="color: #bbbbbb"> </span><span style="color: #666666">&gt;</span><span style="color: #bbbbbb"> </span><span style="color: #666666">1</span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">            </span><span style="color: #3D7B7B; font-style: italic">//send alert</span>
<span style="color: #bbbbbb">        </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">        </span><span style="color: #008000; font-weight: bold">if</span><span style="color: #bbbbbb"> </span>((level_pressure_data<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;</span><span style="color: #bbbbbb"> </span><span style="color: #666666">3</span>)<span style="color: #bbbbbb"> </span><span style="color: #666666">||</span><span style="color: #bbbbbb"> </span>(level_tape_data<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;</span><span style="color: #bbbbbb"> </span><span style="color: #666666">3</span>)){<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">            </span><span style="color: #3D7B7B; font-style: italic">//send alert</span>
<span style="color: #bbbbbb">        </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">        </span><span style="color: #008000; font-weight: bold">if</span><span style="color: #bbbbbb"> </span>(timer<span style="color: #bbbbbb"> </span><span style="color: #666666">&gt;</span><span style="color: #bbbbbb"> </span><span style="color: #666666">20</span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">            </span><span style="color: #3D7B7B; font-style: italic">//send alert</span>
<span style="color: #bbbbbb">            </span>digitalWrite(switch_pin,<span style="color: #bbbbbb"> </span>HIGH);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">            </span><span style="color: #008000; font-weight: bold">break</span>;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">        </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">        </span>delay(<span style="color: #666666">3000</span>);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #008000; font-weight: bold">return</span><span style="color: #bbbbbb"> </span>timer;<span style="color: #bbbbbb"></span>
}<span style="color: #bbbbbb"></span>
</pre></div>
<p>
<p>
<!-- navigation buttons at the bottom of the page -->
<ul class="pager">

  <li class="previous">
    <a href="IoTProjects005.html">&larr; Prev</a>
  </li>

  <li class="next">
    <a href="IoTProjects007.html">Next &rarr;</a>
  </li>
</ul>
<!-- ------------------- end of main content --------------- -->

</div>  <!-- end container -->
<!-- include javascript, jQuery *first* -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>

<!-- Bootstrap footer
<footer>
<a href="http://..."><img width="250" align=right src="http://..."></a>
</footer>
-->


<center style="font-size:80%">
<!-- copyright only on the titlepage -->
</center>


</body>
</html>
    

