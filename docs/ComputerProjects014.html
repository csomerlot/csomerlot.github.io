<!--
Automatically generated HTML file from DocOnce source
(https://github.com/hplgit/doconce/)
-->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="DocOnce: https://github.com/hplgit/doconce/" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="description" content="Computer Projects">

<title>Computer Projects</title>

<!-- Bootstrap style: bootstrap_blue -->
<link href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.rawgit.com/hplgit/doconce/master/bundled/html_styles/style_bootstrap/css/bootstrap_blue.css" rel="stylesheet">
<!-- not necessary
<link href="https://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
-->

<style type="text/css">

/* Add scrollbar to dropdown menus in bootstrap navigation bar */
.dropdown-menu {
   height: auto;
   max-height: 400px;
   overflow-x: hidden;
}

/* Adds an invisible element before each target to offset for the navigation
   bar */
.anchor::before {
  content:"";
  display:block;
  height:50px;      /* fixed header height for style bootstrap_blue */
  margin:-50px 0 0; /* negative fixed header height */
}
</style>


</head>

<!-- tocinfo
{'highest level': 1,
 'sections': [('Table of contents',
               1,
               'table_of_contents',
               'table_of_contents'),
              ('Robotics Club Setup', 1, None, '___sec0'),
              ('Home Internet Gateway', 1, None, '___sec1'),
              ('Arduino Wind Instrument', 1, None, '___sec2'),
              ('Motocomms', 1, None, '___sec3'),
              ('Track GDD', 1, None, '___sec4'),
              ('Tartan designer', 1, None, '___sec5'),
              ('Somerlot Shooting Support System (S4)', 1, None, '___sec6'),
              ('Retail support tools', 1, None, '___sec7'),
              ('Scheduler', 2, None, '___sec8'),
              ('Rewards Program Calculator', 2, None, '___sec9'),
              ('Common Mobile Compute Platform', 1, None, '___sec10'),
              ('Domotics', 1, None, '___sec11'),
              ('Automotive Media System', 1, None, '___sec12'),
              ('GPS Chartplotter', 1, None, '___sec13'),
              ('Common Sensor and Datalogger Platform', 1, None, '___sec14'),
              ('Micro Hydroponics', 1, None, '___sec15'),
              ('Technology as Art', 1, None, '___sec16'),
              ('Wood Burning Plotter', 2, None, '___sec17'),
              ('Lightning Catcher', 2, None, '___sec18'),
              ('Irrigation Remote', 1, None, '___sec19'),
              ('The Best Damn Radio System', 1, None, '___sec20'),
              ('Fixed Wing UAV', 1, None, '___sec21'),
              ('Submersible / Surface ROV', 1, None, '___sec22'),
              ('Pool Octobot', 1, None, '___sec23'),
              ('Scarecrow Targeting System', 1, None, '___sec24'),
              ('Invasive Species Patroller', 1, None, '___sec25'),
              ('Signal-Tracking Antenna Mount', 1, None, '___sec26')]}
end of tocinfo -->

<body>

    
<!-- Bootstrap navigation bar -->
<div class="navbar navbar-default navbar-fixed-top">
  <div class="navbar-header">
    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-responsive-collapse">
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
    <a class="navbar-brand" href="ComputerProjects.html">Computer Projects</a>
  </div>

  <div class="navbar-collapse collapse navbar-responsive-collapse">
    <ul class="nav navbar-nav navbar-right">
      <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Contents <b class="caret"></b></a>
        <ul class="dropdown-menu">
     <!-- navigation toc: --> <li><a href="ComputerProjects020.html#table_of_contents" style="font-size: 80%;"><b>Table of contents</b></a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects001.html#___sec0" style="font-size: 80%;"><b>Robotics Club Setup</b></a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects002.html#___sec1" style="font-size: 80%;"><b>Home Internet Gateway</b></a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects003.html#___sec2" style="font-size: 80%;"><b>Arduino Wind Instrument</b></a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects004.html#___sec3" style="font-size: 80%;"><b>Motocomms</b></a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects005.html#___sec4" style="font-size: 80%;"><b>Track GDD</b></a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects006.html#___sec5" style="font-size: 80%;"><b>Tartan designer</b></a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects007.html#___sec6" style="font-size: 80%;"><b>Somerlot Shooting Support System (S4)</b></a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects008.html#___sec7" style="font-size: 80%;"><b>Retail support tools</b></a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects008.html#___sec8" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;Scheduler</a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects008.html#___sec9" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;Rewards Program Calculator</a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects010.html#___sec10" style="font-size: 80%;"><b>Common Mobile Compute Platform</b></a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects011.html#___sec11" style="font-size: 80%;"><b>Domotics</b></a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects012.html#___sec12" style="font-size: 80%;"><b>Automotive Media System</b></a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects013.html#___sec13" style="font-size: 80%;"><b>GPS Chartplotter</b></a></li>
     <!-- navigation toc: --> <li><a href="#___sec14" style="font-size: 80%;"><b>Common Sensor and Datalogger Platform</b></a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects015.html#___sec15" style="font-size: 80%;"><b>Micro Hydroponics</b></a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects016.html#___sec16" style="font-size: 80%;"><b>Technology as Art</b></a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects016.html#___sec17" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;Wood Burning Plotter</a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects016.html#___sec18" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;Lightning Catcher</a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects017.html#___sec19" style="font-size: 80%;"><b>Irrigation Remote</b></a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects018.html#___sec20" style="font-size: 80%;"><b>The Best Damn Radio System</b></a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects021.html#___sec21" style="font-size: 80%;"><b>Fixed Wing UAV</b></a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects022.html#___sec22" style="font-size: 80%;"><b>Submersible / Surface ROV</b></a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects023.html#___sec23" style="font-size: 80%;"><b>Pool Octobot</b></a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects024.html#___sec24" style="font-size: 80%;"><b>Scarecrow Targeting System</b></a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects025.html#___sec25" style="font-size: 80%;"><b>Invasive Species Patroller</b></a></li>
     <!-- navigation toc: --> <li><a href="ComputerProjects026.html#___sec26" style="font-size: 80%;"><b>Signal-Tracking Antenna Mount</b></a></li>

        </ul>
      </li>
    </ul>
  </div>
</div>
</div> <!-- end of navigation bar -->

<div class="container">

<p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p> <!-- add vertical space -->

<a name="part0014"></a>
<!-- !split -->

<h1 id="___sec14" class="anchor">Common Sensor and Datalogger Platform </h1>
<b>Description:</b>
Portable and wireless environmental IoT sensor and datalogger

<p>
<b>User Story:</b>
We want to be able measure a variety of environmental conditions, without hooking up wiring. We can place a sensor indoors or outdoors just for
spot checks or leave it for several weeks or add a solar power pack for permanent power. We can hook it up to a dashboard to monitor and
provide alarms, or use it in more remote conditions and have it upload once wifi is available, or use a cell modem. Some possible applications include:

<ul>
<li> Dive computer</li>
<li> Bike computer</li>
<li> Drone computer</li>
<li> Weather Balloon computer</li>
<li> Environmental Datalogger</li>
<li> Marine Chartplotter</li>
<li> Indoor air quality</li>
<li> Energy Monitor</li>
<li> Domotics, solar, or hydroponics controller</li>
</ul>

<b>Feature Set:</b>

<ul>
<li> Internet connection discovery and automatic frequent communication</li>
<li> Plenty of digital and analog inputs</li>
<li> LCD Screen and a few buttons for basic status and config</li>
<li> 2-week battery life</li>
<li> Watertight potting and enclosure (100m)</li>
<li> Shock-proof (shotgun at 10m)</li>
<li> ports for display, antenna, power, and USB</li>
<li> Wifi as base networking capability, with CDMA, Ham (APRS transmitter) and LoRa communications as options</li>
</ul>

<b>Phasing:</b>

<ul>
<li> Base unit build-out and config</li>
<li> develop ports</li>
<li> ruggedize</li>
</ul>

<b>BOM:</b>

<ul>
<li> Base Unit: <a href="https://www.adafruit.com/product/3010" target="_self">Adafruit Feather M0 WiFi - ATSAMD21 + ATWINC1500</a></li>
<li> Base Unit: <a href="https://www.adafruit.com/product/353" target="_self">Lithium Ion Battery Pack - 3.7V 6600mAh</a></li>
<li> Base Unit: <a href="https://www.adafruit.com/product/2900" target="_self">Adafruit FeatherWing OLED - 128x32 OLED Add-on For Feather</a></li>
<li> <a href="https://www.adafruit.com/product/3660" target="_self">Air Temperature, Humidity, Pressure and Gas Sensor</a></li>
<li> <a href="https://www.adafruit.com/product/3686" target="_self">Air Quality Sensor</a></li>
<li> <a href="https://www.adafruit.com/product/3709" target="_self">Air Quality Sensor Breakout - VOC and eCO2</a></li>
<li> <a href="https://www.adafruit.com/product/3199" target="_self">CO, Alcohol and VOC Gas Sensor</a></li>
<li> <a href="https://www.digikey.com/products/en?keywords=165D6042P003" target="_self">Water turbidity and temp</a></li>
<li> <a href="https://www.digikey.com/products/en?keywords=480-6244-ND" target="_self">Water pressure</a></li>
<li> <a href="https://tinyurl.com/y4jmsg6z" target="_self">Non-intrusive current sensors</a></li>
</ul>

<b>Notes:</b>

<ul>
<li> <a href="https://io.adafruit.com/" target="_self">Adafruit.io</a> for dashboard and short-term data warehousing</li>
<li> <a href="https://learn.adafruit.com/make-it-data-log-spreadsheet-circuit-playground" target="_self"><tt>https://learn.adafruit.com/make-it-data-log-spreadsheet-circuit-playground</tt></a></li>
<li> <a href="https://thecavepearlproject.org/" target="_self"><tt>https://thecavepearlproject.org/</tt></a></li>
<li> <a href="https://learn.adafruit.com/remote-iot-environmental-sensor/overview" target="_self"><tt>https://learn.adafruit.com/remote-iot-environmental-sensor/overview</tt></a></li>
</ul>

<b>Logic:</b>

<ol>
<li> Controller:

<ol type="a"></li>
   <li> Read data</li>
   <li> Save data to data file</li>
   <li> If communications enabled:</li>

<ol>
       <li> If MQTT feed not present, establish one</li>
</ol>

   <li> Log everything</li>
   <li> Pause (vary time by event status or actively via MQTT)</li>

<ol>
       <li> break if button is pressed</li>
</ol>

   <li> loop back to step 2</li>
</ol>

<li> Host:

<ol type="a"></li>
   <li> Check for alarm levels</li>
   <li> Log everything</li>
</ol>

</ol>

<b>Controller Arduino Code:</b>

<p>

<!-- code=c (!bc cpro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%;"><span></span><span style="color: #9C6500">#include</span><span style="color: #bbbbbb"> </span><span style="color: #3D7B7B; font-style: italic">&lt;Wire.h&gt;</span><span style="color: #9C6500"></span>
<span style="color: #9C6500">#include</span><span style="color: #bbbbbb"> </span><span style="color: #3D7B7B; font-style: italic">&quot;RTClib.h&quot;</span><span style="color: #9C6500"></span>
<span style="color: #9C6500">#include</span><span style="color: #bbbbbb"> </span><span style="color: #3D7B7B; font-style: italic">&lt;SPI.h&gt;</span><span style="color: #9C6500"></span>
<span style="color: #9C6500">#include</span><span style="color: #bbbbbb"> </span><span style="color: #3D7B7B; font-style: italic">&lt;SD.h&gt;</span><span style="color: #9C6500"></span>
<span style="color: #9C6500">#include</span><span style="color: #bbbbbb"> </span><span style="color: #3D7B7B; font-style: italic">&lt;WiFi101.h&gt;</span><span style="color: #9C6500"></span>
<span style="color: #9C6500">#include</span><span style="color: #bbbbbb"> </span><span style="color: #3D7B7B; font-style: italic">&quot;Adafruit_MQTT.h&quot;</span><span style="color: #9C6500"></span>
<span style="color: #9C6500">#include</span><span style="color: #bbbbbb"> </span><span style="color: #3D7B7B; font-style: italic">&quot;Adafruit_MQTT_Client.h&quot;</span><span style="color: #9C6500"></span>
<span style="color: #9C6500">#include</span><span style="color: #bbbbbb"> </span><span style="color: #3D7B7B; font-style: italic">&quot;keysandstuff.h&quot;</span><span style="color: #9C6500"></span>

<span style="color: #3D7B7B; font-style: italic">// Adafruit IO Analog In Example</span>
<span style="color: #3D7B7B; font-style: italic">// Tutorial Link: https://learn.adafruit.com/adafruit-io-basics-analog-input</span>
<span style="color: #3D7B7B; font-style: italic">//</span>
<span style="color: #3D7B7B; font-style: italic">// Adafruit invests time and resources providing this open source code.</span>
<span style="color: #3D7B7B; font-style: italic">// Please support Adafruit and open source hardware by purchasing</span>
<span style="color: #3D7B7B; font-style: italic">// products from Adafruit!</span>
<span style="color: #3D7B7B; font-style: italic">//</span>
<span style="color: #3D7B7B; font-style: italic">// Written by Todd Treece for Adafruit Industries</span>
<span style="color: #3D7B7B; font-style: italic">// Copyright (c) 2016 Adafruit Industries</span>
<span style="color: #3D7B7B; font-style: italic">// Licensed under the MIT license.</span>
<span style="color: #3D7B7B; font-style: italic">//</span>
<span style="color: #3D7B7B; font-style: italic">// All text above must be included in any redistribution.</span>


<span style="color: #3D7B7B; font-style: italic">/* COMMON DATA LOGGING PLATFORM</span>
<span style="color: #3D7B7B; font-style: italic">This code:</span>
<span style="color: #3D7B7B; font-style: italic">- uses MQTT for light-weight communication, data delivery verification</span>
<span style="color: #3D7B7B; font-style: italic">- blinks an error code via the built-in LED</span>
<span style="color: #3D7B7B; font-style: italic">- writes data and log messages to an SD card</span>
<span style="color: #3D7B7B; font-style: italic">- uses a RTC module for acurate time stamps</span>
<span style="color: #3D7B7B; font-style: italic">- runs mostly in low-power mode</span>
<span style="color: #3D7B7B; font-style: italic">- can change behavoir dynamically via MQTT or on-board buttons</span>
<span style="color: #3D7B7B; font-style: italic">- shows status via OLED</span>
<span style="color: #3D7B7B; font-style: italic">*/</span><span style="color: #bbbbbb"></span>

<span style="color: #3D7B7B; font-style: italic">// RTC clock setup</span>
<span style="color: #9C6500">#if defined(ARDUINO_ARCH_SAMD)</span>
<span style="color: #9C6500">#endif</span>

<span style="color: #3D7B7B; font-style: italic">//Set up the wifi client</span>
WiFiClient<span style="color: #bbbbbb"> </span>client;<span style="color: #bbbbbb"></span>

Adafruit_MQTT_Client<span style="color: #bbbbbb"> </span><span style="color: #0000FF">mqtt</span>(<span style="color: #666666">&amp;</span>client,<span style="color: #bbbbbb"> </span>AIO_SERVER,<span style="color: #bbbbbb"> </span>AIO_SERVERPORT,<span style="color: #bbbbbb"> </span>AIO_USERNAME,<span style="color: #bbbbbb"> </span>AIO_KEY);<span style="color: #bbbbbb"></span>

<span style="color: #3D7B7B; font-style: italic">//#define halt(s) { Serial.println(F( s )); while(1);  }</span>

<span style="color: #3D7B7B; font-style: italic">/****************************** Feeds ***************************************/</span><span style="color: #bbbbbb"></span>

<span style="color: #3D7B7B; font-style: italic">// Notice MQTT paths for AIO follow the form: &lt;username&gt;/feeds/&lt;feedname&gt;</span>
Adafruit_MQTT_Publish<span style="color: #bbbbbb"> </span>Depth<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb">             </span>Adafruit_MQTT_Publish(<span style="color: #666666">&amp;</span>mqtt,<span style="color: #bbbbbb"> </span>AIO_USERNAME<span style="color: #bbbbbb"> </span><span style="color: #BA2121">&quot;/feeds/&quot;</span><span style="color: #bbbbbb"> </span>SITE_NAME<span style="color: #bbbbbb"> </span><span style="color: #BA2121">&quot;.stage-dn&quot;</span>);<span style="color: #bbbbbb"></span>
Adafruit_MQTT_Publish<span style="color: #bbbbbb"> </span>Temperature<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb">       </span>Adafruit_MQTT_Publish(<span style="color: #666666">&amp;</span>mqtt,<span style="color: #bbbbbb"> </span>AIO_USERNAME<span style="color: #bbbbbb"> </span><span style="color: #BA2121">&quot;/feeds/&quot;</span><span style="color: #bbbbbb"> </span>SITE_NAME<span style="color: #bbbbbb"> </span><span style="color: #BA2121">&quot;.temperature-dn&quot;</span>);<span style="color: #bbbbbb"></span>
Adafruit_MQTT_Publish<span style="color: #bbbbbb"> </span>TSS<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb">               </span>Adafruit_MQTT_Publish(<span style="color: #666666">&amp;</span>mqtt,<span style="color: #bbbbbb"> </span>AIO_USERNAME<span style="color: #bbbbbb"> </span><span style="color: #BA2121">&quot;/feeds/&quot;</span><span style="color: #bbbbbb"> </span>SITE_NAME<span style="color: #bbbbbb"> </span><span style="color: #BA2121">&quot;.tss-dn&quot;</span>);<span style="color: #bbbbbb"></span>
Adafruit_MQTT_Publish<span style="color: #bbbbbb"> </span>Voltage<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb">           </span>Adafruit_MQTT_Publish(<span style="color: #666666">&amp;</span>mqtt,<span style="color: #bbbbbb"> </span>AIO_USERNAME<span style="color: #bbbbbb"> </span><span style="color: #BA2121">&quot;/feeds/&quot;</span><span style="color: #bbbbbb"> </span>SITE_NAME<span style="color: #bbbbbb"> </span><span style="color: #BA2121">&quot;.voltage-dn&quot;</span>);<span style="color: #bbbbbb"></span>
Adafruit_MQTT_Publish<span style="color: #bbbbbb"> </span>Depth_calc<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb">        </span>Adafruit_MQTT_Publish(<span style="color: #666666">&amp;</span>mqtt,<span style="color: #bbbbbb"> </span>AIO_USERNAME<span style="color: #bbbbbb"> </span><span style="color: #BA2121">&quot;/feeds/&quot;</span><span style="color: #bbbbbb"> </span>SITE_NAME<span style="color: #bbbbbb"> </span><span style="color: #BA2121">&quot;.stage-m&quot;</span>);<span style="color: #bbbbbb"></span>
Adafruit_MQTT_Publish<span style="color: #bbbbbb"> </span>Temperature_calc<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb">  </span>Adafruit_MQTT_Publish(<span style="color: #666666">&amp;</span>mqtt,<span style="color: #bbbbbb"> </span>AIO_USERNAME<span style="color: #bbbbbb"> </span><span style="color: #BA2121">&quot;/feeds/&quot;</span><span style="color: #bbbbbb"> </span>SITE_NAME<span style="color: #bbbbbb"> </span><span style="color: #BA2121">&quot;.temperature-f&quot;</span>);<span style="color: #bbbbbb"></span>
Adafruit_MQTT_Publish<span style="color: #bbbbbb"> </span>TSS_calc<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb">          </span>Adafruit_MQTT_Publish(<span style="color: #666666">&amp;</span>mqtt,<span style="color: #bbbbbb"> </span>AIO_USERNAME<span style="color: #bbbbbb"> </span><span style="color: #BA2121">&quot;/feeds/&quot;</span><span style="color: #bbbbbb"> </span>SITE_NAME<span style="color: #bbbbbb"> </span><span style="color: #BA2121">&quot;.tss-mg-per-l&quot;</span>);<span style="color: #bbbbbb"></span>
Adafruit_MQTT_Publish<span style="color: #bbbbbb"> </span>Voltage_calc<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb">      </span>Adafruit_MQTT_Publish(<span style="color: #666666">&amp;</span>mqtt,<span style="color: #bbbbbb"> </span>AIO_USERNAME<span style="color: #bbbbbb"> </span><span style="color: #BA2121">&quot;/feeds/&quot;</span><span style="color: #bbbbbb"> </span>SITE_NAME<span style="color: #bbbbbb"> </span><span style="color: #BA2121">&quot;.voltage-V&quot;</span>);<span style="color: #bbbbbb"></span>

RTC_PCF8523<span style="color: #bbbbbb"> </span>rtc;<span style="color: #bbbbbb"></span>
File<span style="color: #bbbbbb"> </span>logfile;<span style="color: #bbbbbb"></span>

<span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>sdStatus<span style="color: #bbbbbb">   </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>;<span style="color: #bbbbbb"></span>
<span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>wifiStatus<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>;<span style="color: #bbbbbb"></span>
<span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>RTCstatus<span style="color: #bbbbbb">  </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>;<span style="color: #bbbbbb"></span>
<span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>oledStatus<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>;<span style="color: #bbbbbb"></span>
<span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>serialStatus<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>;<span style="color: #bbbbbb"></span>

<span style="color: #3D7B7B; font-style: italic">// blink out an error code</span>
<span style="color: #B00040">void</span><span style="color: #bbbbbb"> </span><span style="color: #0000FF">error</span>(<span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>errno)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #3D7B7B; font-style: italic">/* ERROR CODES</span>
<span style="color: #3D7B7B; font-style: italic">1 - no network</span>
<span style="color: #3D7B7B; font-style: italic">2 - no sd card</span>
<span style="color: #3D7B7B; font-style: italic">3 - no RTC</span>
<span style="color: #3D7B7B; font-style: italic">*/</span><span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #008000; font-weight: bold">while</span>(<span style="color: #666666">1</span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #B00040">uint8_t</span><span style="color: #bbbbbb"> </span>i;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(i<span style="color: #666666">=0</span>;<span style="color: #bbbbbb"> </span>i<span style="color: #666666">&lt;</span>errno;<span style="color: #bbbbbb"> </span>i<span style="color: #666666">++</span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span>digitalWrite(<span style="color: #666666">13</span>,<span style="color: #bbbbbb"> </span>HIGH);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span>delay(<span style="color: #666666">100</span>);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span>digitalWrite(<span style="color: #666666">13</span>,<span style="color: #bbbbbb"> </span>LOW);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span>delay(<span style="color: #666666">100</span>);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(i<span style="color: #666666">=</span>errno;<span style="color: #bbbbbb"> </span>i<span style="color: #666666">&lt;10</span>;<span style="color: #bbbbbb"> </span>i<span style="color: #666666">++</span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span>delay(<span style="color: #666666">200</span>);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>}<span style="color: #bbbbbb"></span>
}<span style="color: #bbbbbb"></span>

<span style="color: #B00040">void</span><span style="color: #bbbbbb"> </span><span style="color: #0000FF">setup</span>()<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #3D7B7B; font-style: italic">//status = WL_IDLE_STATUS;</span>
<span style="color: #bbbbbb">  </span><span style="color: #3D7B7B; font-style: italic">// start the serial connection, sets rate of data transmission</span>
<span style="color: #bbbbbb">  </span>Serial.begin(<span style="color: #666666">115200</span>);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #3D7B7B; font-style: italic">// wait for serial monitor to open</span>
<span style="color: #bbbbbb">  </span><span style="color: #008000; font-weight: bold">while</span><span style="color: #bbbbbb"> </span>(<span style="color: #666666">!</span>Serial);<span style="color: #bbbbbb"></span>


<span style="color: #bbbbbb">  </span><span style="color: #3D7B7B; font-style: italic">// see if the card is present and can be initialized:</span>
<span style="color: #bbbbbb">  </span><span style="color: #008000; font-weight: bold">if</span><span style="color: #bbbbbb"> </span>(<span style="color: #666666">!</span>SD.begin(cardSelect))<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>Serial.println(<span style="color: #BA2121">&quot;Card init. failed!&quot;</span>);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>error(<span style="color: #666666">2</span>);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #B00040">char</span><span style="color: #bbbbbb"> </span>filename[<span style="color: #666666">15</span>];<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>strcpy(filename,<span style="color: #bbbbbb"> </span><span style="color: #BA2121">&quot;LOG00.CSV&quot;</span>);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #008000; font-weight: bold">for</span><span style="color: #bbbbbb"> </span>(<span style="color: #B00040">uint8_t</span><span style="color: #bbbbbb"> </span>i<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>;<span style="color: #bbbbbb"> </span>i<span style="color: #bbbbbb"> </span><span style="color: #666666">&lt;</span><span style="color: #bbbbbb"> </span><span style="color: #666666">100</span>;<span style="color: #bbbbbb"> </span>i<span style="color: #666666">++</span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>filename[<span style="color: #666666">3</span>]<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #BA2121">&#39;0&#39;</span><span style="color: #bbbbbb"> </span><span style="color: #666666">+</span><span style="color: #bbbbbb"> </span>i<span style="color: #666666">/10</span>;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>filename[<span style="color: #666666">4</span>]<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #BA2121">&#39;0&#39;</span><span style="color: #bbbbbb"> </span><span style="color: #666666">+</span><span style="color: #bbbbbb"> </span>i<span style="color: #666666">%10</span>;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #3D7B7B; font-style: italic">// create if does not exist, do not open existing, write, sync after write</span>
<span style="color: #bbbbbb">    </span><span style="color: #008000; font-weight: bold">if</span><span style="color: #bbbbbb"> </span>(<span style="color: #666666">!</span><span style="color: #bbbbbb"> </span>SD.exists(filename))<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">      </span><span style="color: #008000; font-weight: bold">break</span>;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>}<span style="color: #bbbbbb"></span>

<span style="color: #bbbbbb">  </span>logfile<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>SD.open(filename,<span style="color: #bbbbbb"> </span>FILE_WRITE);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #008000; font-weight: bold">if</span>(<span style="color: #bbbbbb"> </span><span style="color: #666666">!</span><span style="color: #bbbbbb"> </span>logfile<span style="color: #bbbbbb"> </span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>Serial.print(<span style="color: #BA2121">&quot;Couldnt create &quot;</span>);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>Serial.println(filename);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>error(<span style="color: #666666">3</span>);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>Serial.print(<span style="color: #BA2121">&quot;Writing to &quot;</span>);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>Serial.println(filename);<span style="color: #bbbbbb"></span>

<span style="color: #bbbbbb">  </span><span style="color: #3D7B7B; font-style: italic">// Wifi init</span>
<span style="color: #bbbbbb">  </span><span style="color: #3D7B7B; font-style: italic">//WiFi pins specific to the Adafruit Feather M0 WiFi - ATSAMD21 + ATWINC1500 breakout board</span>
<span style="color: #bbbbbb">  </span>WiFi.setPins(<span style="color: #666666">8</span>,<span style="color: #666666">7</span>,<span style="color: #666666">4</span>,<span style="color: #666666">2</span>);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #3D7B7B; font-style: italic">// attempt to connect to Wifi network:</span>
<span style="color: #bbbbbb">  </span><span style="color: #3D7B7B; font-style: italic">// Initialise the Client</span>
<span style="color: #bbbbbb">  </span>Serial.print(F(<span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">Init the WiFi module...&quot;</span>));<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #3D7B7B; font-style: italic">// check for the presence of the breakout</span>

<span style="color: #bbbbbb">  </span><span style="color: #3D7B7B; font-style: italic">// SD Card setup</span>
<span style="color: #bbbbbb">  </span><span style="color: #3D7B7B; font-style: italic">// Set the pins used</span>
<span style="color: #bbbbbb">  </span><span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>cardSelect<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">10</span><span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #008000; font-weight: bold">if</span><span style="color: #bbbbbb"> </span>(WiFi.status()<span style="color: #bbbbbb"> </span><span style="color: #666666">==</span><span style="color: #bbbbbb"> </span>WL_NO_SHIELD)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>Serial.println(<span style="color: #BA2121">&quot;WINC1500 not present&quot;</span>);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #3D7B7B; font-style: italic">// don&#39;t continue:</span>
<span style="color: #bbbbbb">    </span><span style="color: #008000; font-weight: bold">while</span><span style="color: #bbbbbb"> </span>(<span style="color: #008000">true</span>);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>Serial.println(<span style="color: #BA2121">&quot;ATWINC OK!&quot;</span>);<span style="color: #bbbbbb"></span>

<span style="color: #bbbbbb">  </span><span style="color: #008000; font-weight: bold">if</span><span style="color: #bbbbbb"> </span>(<span style="color: #666666">!</span><span style="color: #bbbbbb"> </span>rtc.begin())<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>Serial.println(<span style="color: #BA2121">&quot;Couldn&#39;t find RTC&quot;</span>);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #008000; font-weight: bold">while</span><span style="color: #bbbbbb"> </span>(<span style="color: #666666">1</span>);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>}<span style="color: #bbbbbb"></span>

<span style="color: #bbbbbb">  </span><span style="color: #008000; font-weight: bold">if</span><span style="color: #bbbbbb"> </span>(<span style="color: #666666">!</span><span style="color: #bbbbbb"> </span>rtc.initialized())<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>Serial.println(<span style="color: #BA2121">&quot;RTC is NOT running!&quot;</span>);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>error(<span style="color: #666666">3</span>);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span>}<span style="color: #bbbbbb"></span>

<span style="color: #bbbbbb">  </span>pinMode(<span style="color: #666666">13</span>,<span style="color: #bbbbbb"> </span>OUTPUT);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">  </span><span style="color: #3D7B7B; font-style: italic">//pinMode(8, OUTPUT);</span>


<span style="color: #bbbbbb">  </span>Serial.println(<span style="color: #BA2121">&quot;Ready!</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span>);<span style="color: #bbbbbb"></span>
}<span style="color: #bbbbbb"></span>

<span style="color: #B00040">void</span><span style="color: #bbbbbb"> </span><span style="color: #0000FF">loop</span>()<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>

<span style="color: #bbbbbb">    </span><span style="color: #3D7B7B; font-style: italic">// read the input on analog pin A0 A1 A2 A3</span>
<span style="color: #bbbbbb">    </span><span style="color: #3D7B7B; font-style: italic">// Calculate water quality parameters using equations from calibration curves</span>
<span style="color: #bbbbbb">    </span><span style="color: #3D7B7B; font-style: italic">// These variables are required for the below functions</span>
<span style="color: #bbbbbb">    </span>Serial.println(<span style="color: #BA2121">&quot;Reading pins&quot;</span>);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>Depth_pin<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>analogRead(A0);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>TSS_pin<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>analogRead(A1);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>Temp_pin<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>analogRead(A2);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>Volt_pin<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>analogRead(A3);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #B00040">float</span><span style="color: #bbbbbb"> </span>Depth_m<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0.0075*</span>(<span style="color: #B00040">float</span>(Depth_pin))<span style="color: #666666">-0.7786</span>;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #B00040">float</span><span style="color: #bbbbbb"> </span>TSS_mgL<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">23977*</span>exp(<span style="color: #666666">-0.007*</span><span style="color: #B00040">float</span>(TSS_pin));<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #B00040">float</span><span style="color: #bbbbbb"> </span>Temp_F<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0.2165*</span>(<span style="color: #B00040">float</span>(Temp_pin))<span style="color: #666666">-7.6926</span>;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #B00040">float</span><span style="color: #bbbbbb"> </span>Volt_V<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>Volt_pin;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>Serial.println(<span style="color: #BA2121">&quot;Writing data&quot;</span>);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>SD_write(<span style="color: #bbbbbb">   </span>Depth_pin,<span style="color: #bbbbbb"> </span>TSS_pin,<span style="color: #bbbbbb"> </span>Temp_pin,<span style="color: #bbbbbb"> </span>Volt_pin,<span style="color: #bbbbbb"> </span>Depth_m,<span style="color: #bbbbbb"> </span>TSS_mgL,<span style="color: #bbbbbb"> </span>Temp_F,<span style="color: #bbbbbb"> </span>Volt_V);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>IO_publish(<span style="color: #bbbbbb"> </span>Depth_pin,<span style="color: #bbbbbb"> </span>TSS_pin,<span style="color: #bbbbbb"> </span>Temp_pin,<span style="color: #bbbbbb"> </span>Volt_pin,<span style="color: #bbbbbb"> </span>Depth_m,<span style="color: #bbbbbb"> </span>TSS_mgL,<span style="color: #bbbbbb"> </span>Temp_F,<span style="color: #bbbbbb"> </span>Volt_V);<span style="color: #bbbbbb"></span>

<span style="color: #bbbbbb">    </span>delay(LOOP_DELAY);<span style="color: #bbbbbb"></span>
}<span style="color: #bbbbbb"></span>

<span style="color: #B00040">void</span><span style="color: #bbbbbb"> </span><span style="color: #0000FF">MQTT_connect</span>()<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #3D7B7B; font-style: italic">// Function to connect and reconnect as necessary to the MQTT server.</span>
<span style="color: #bbbbbb">    </span><span style="color: #3D7B7B; font-style: italic">// Should be called in the loop function and it will take care if connecting.</span>
<span style="color: #bbbbbb">    </span><span style="color: #B00040">int8_t</span><span style="color: #bbbbbb"> </span>ret;<span style="color: #bbbbbb"></span>

<span style="color: #bbbbbb">    </span><span style="color: #3D7B7B; font-style: italic">// attempt to connect to Wifi network:</span>
<span style="color: #bbbbbb">    </span><span style="color: #008000; font-weight: bold">while</span><span style="color: #bbbbbb"> </span>(WiFi.status()<span style="color: #bbbbbb"> </span><span style="color: #666666">!=</span><span style="color: #bbbbbb"> </span>WL_CONNECTED)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">        </span>Serial.print(<span style="color: #BA2121">&quot;Attempting to connect to Primary   SSID: &quot;</span>);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">        </span>Serial.println(ssid);<span style="color: #bbbbbb"></span>

<span style="color: #bbbbbb">        </span>status<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>WiFi.begin(ssid);<span style="color: #bbbbbb"></span>

<span style="color: #bbbbbb">        </span><span style="color: #3D7B7B; font-style: italic">// wait xx seconds for connection:</span>
<span style="color: #bbbbbb">        </span><span style="color: #B00040">uint8_t</span><span style="color: #bbbbbb"> </span>timeout<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">15</span>;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">        </span><span style="color: #008000; font-weight: bold">while</span><span style="color: #bbbbbb"> </span>(timeout<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;&amp;</span><span style="color: #bbbbbb"> </span>(WiFi.status()<span style="color: #bbbbbb"> </span><span style="color: #666666">!=</span><span style="color: #bbbbbb"> </span>WL_CONNECTED))<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">          </span>timeout<span style="color: #666666">--</span>;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">          </span>delay(<span style="color: #666666">1000</span>);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">        </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>}<span style="color: #bbbbbb"></span>

<span style="color: #bbbbbb">    </span><span style="color: #3D7B7B; font-style: italic">// Stop if already connected.</span>
<span style="color: #bbbbbb">    </span><span style="color: #008000; font-weight: bold">if</span><span style="color: #bbbbbb"> </span>(mqtt.connected())<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">        </span><span style="color: #008000; font-weight: bold">return</span>;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>}<span style="color: #bbbbbb"></span>

<span style="color: #bbbbbb">    </span>Serial.print(<span style="color: #BA2121">&quot;Connecting to MQTT... &quot;</span>);<span style="color: #bbbbbb"></span>

<span style="color: #bbbbbb">    </span><span style="color: #008000; font-weight: bold">while</span><span style="color: #bbbbbb"> </span>((ret<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>mqtt.connect())<span style="color: #bbbbbb"> </span><span style="color: #666666">!=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">0</span>)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"> </span><span style="color: #3D7B7B; font-style: italic">// connect will return 0 for connected</span>
<span style="color: #bbbbbb">         </span>Serial.println(mqtt.connectErrorString(ret));<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">         </span>Serial.println(<span style="color: #BA2121">&quot;Retrying MQTT connection in 5 seconds...&quot;</span>);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">         </span>mqtt.disconnect();<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">         </span>delay(<span style="color: #666666">5000</span>);<span style="color: #bbbbbb">  </span><span style="color: #3D7B7B; font-style: italic">// wait 5 seconds</span>
<span style="color: #bbbbbb">    </span>}<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>Serial.println(<span style="color: #BA2121">&quot;MQTT Connected!&quot;</span>);<span style="color: #bbbbbb"></span>
}<span style="color: #bbbbbb"></span>

<span style="color: #B00040">void</span><span style="color: #bbbbbb"> </span><span style="color: #0000FF">SD_write</span>(<span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>Depth_pin,<span style="color: #bbbbbb"> </span><span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>TSS_pin,<span style="color: #bbbbbb"> </span><span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>Temp_pin,<span style="color: #bbbbbb"> </span><span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>Volt_pin,<span style="color: #bbbbbb"> </span><span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>Depth_m,<span style="color: #bbbbbb"> </span><span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>TSS_mgL,<span style="color: #bbbbbb"> </span><span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>Temp_F,<span style="color: #bbbbbb"> </span><span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>Volt_V)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>Serial.println(<span style="color: #BA2121">&quot;  SD card writing function&quot;</span>);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>String<span style="color: #bbbbbb"> </span>line<span style="color: #666666">=</span>timeNow()<span style="color: #666666">+</span><span style="color: #BA2121">&quot;,&quot;</span><span style="color: #666666">+</span>Depth_pin<span style="color: #666666">+</span><span style="color: #BA2121">&quot;,&quot;</span><span style="color: #666666">+</span>TSS_pin<span style="color: #666666">+</span><span style="color: #BA2121">&quot;,&quot;</span><span style="color: #666666">+</span>Temp_pin<span style="color: #666666">+</span><span style="color: #BA2121">&quot;,&quot;</span><span style="color: #666666">+</span>Volt_pin<span style="color: #666666">+</span><span style="color: #BA2121">&quot;,&quot;</span><span style="color: #666666">+</span>Depth_m<span style="color: #666666">+</span><span style="color: #BA2121">&quot;,&quot;</span><span style="color: #666666">+</span>TSS_mgL<span style="color: #666666">+</span><span style="color: #BA2121">&quot;,&quot;</span><span style="color: #666666">+</span>Temp_F<span style="color: #666666">+</span><span style="color: #BA2121">&quot;,&quot;</span><span style="color: #666666">+</span>Volt_V;<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>Serial.println(line);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>logfile.println(line);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>logfile.flush();<span style="color: #bbbbbb"></span>
}<span style="color: #bbbbbb"></span>

<span style="color: #B00040">void</span><span style="color: #bbbbbb"> </span><span style="color: #0000FF">IO_publish</span><span style="color: #bbbbbb"> </span>(<span style="color: #B00040">uint32_t</span><span style="color: #bbbbbb"> </span>d_Depth,<span style="color: #bbbbbb"> </span><span style="color: #B00040">uint32_t</span><span style="color: #bbbbbb"> </span>d_TSS,<span style="color: #bbbbbb"> </span><span style="color: #B00040">uint32_t</span><span style="color: #bbbbbb"> </span>d_Temp,<span style="color: #bbbbbb"> </span><span style="color: #B00040">uint32_t</span><span style="color: #bbbbbb"> </span>d_Volt,<span style="color: #bbbbbb"> </span><span style="color: #B00040">float</span><span style="color: #bbbbbb"> </span>a_Depth,<span style="color: #bbbbbb"> </span><span style="color: #B00040">float</span><span style="color: #bbbbbb"> </span>a_TSS,<span style="color: #bbbbbb"> </span><span style="color: #B00040">float</span><span style="color: #bbbbbb"> </span>a_Temp,<span style="color: #bbbbbb"> </span><span style="color: #B00040">int</span><span style="color: #bbbbbb"> </span>a_Volt)<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>Serial.println(<span style="color: #BA2121">&quot;  IO publishing function&quot;</span>);<span style="color: #bbbbbb"></span>

<span style="color: #bbbbbb">    </span><span style="color: #3D7B7B; font-style: italic">// Ensure the connection to the MQTT server is alive (this will make the first</span>
<span style="color: #bbbbbb">    </span><span style="color: #3D7B7B; font-style: italic">// connection and automatically reconnect when disconnected).  See the MQTT_connect</span>
<span style="color: #bbbbbb">    </span><span style="color: #3D7B7B; font-style: italic">// function definition further below.</span>
<span style="color: #bbbbbb">    </span>MQTT_connect();<span style="color: #bbbbbb"></span>

<span style="color: #bbbbbb">    </span>Serial.print(<span style="color: #BA2121">&quot;Pushing to MQTTserver: &quot;</span>);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #008000; font-weight: bold">if</span><span style="color: #bbbbbb"> </span>(<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>Depth.publish(d_Depth)<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;&amp;</span><span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>Temperature.publish(d_TSS)<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;&amp;</span><span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>TSS.publish(d_Temp)<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;&amp;</span><span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>Voltage.publish(d_Volt)<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;&amp;</span><span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>Depth_calc.publish(a_Depth,<span style="color: #bbbbbb"> </span><span style="color: #666666">3</span>)<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;&amp;</span><span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>TSS_calc.publish(a_TSS,<span style="color: #bbbbbb"> </span><span style="color: #666666">3</span>)<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;&amp;</span><span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>Temperature_calc.publish(a_Temp,<span style="color: #bbbbbb"> </span><span style="color: #666666">3</span>)<span style="color: #bbbbbb"> </span><span style="color: #666666">&amp;&amp;</span><span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>Voltage_calc.publish(a_Volt,<span style="color: #bbbbbb"> </span><span style="color: #666666">3</span>)<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>)<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>Serial.println(<span style="color: #BA2121">&quot;Published&quot;</span>);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>}<span style="color: #bbbbbb"> </span><span style="color: #008000; font-weight: bold">else</span><span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>Serial.println(<span style="color: #BA2121">&quot;Failed!&quot;</span>);<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>}<span style="color: #bbbbbb"></span>
}<span style="color: #bbbbbb"></span>

String<span style="color: #bbbbbb"> </span><span style="color: #0000FF">timeNow</span>()<span style="color: #bbbbbb"> </span>{<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span>DateTime<span style="color: #bbbbbb"> </span>now<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>rtc.now();<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #3D7B7B; font-style: italic">//Serial.println(now.unixtime() / 86400L);</span>
<span style="color: #bbbbbb">    </span>String<span style="color: #bbbbbb"> </span>thistime<span style="color: #bbbbbb"> </span><span style="color: #666666">=</span><span style="color: #bbbbbb"> </span>String(now.month())<span style="color: #666666">+</span><span style="color: #BA2121">&#39;/&#39;</span><span style="color: #666666">+</span>String(now.day())<span style="color: #666666">+</span><span style="color: #BA2121">&#39;/&#39;</span><span style="color: #666666">+</span>String(now.year())<span style="color: #666666">+</span><span style="color: #BA2121">&quot; &quot;</span><span style="color: #666666">+</span>String(now.hour())<span style="color: #666666">+</span><span style="color: #BA2121">&#39;:&#39;</span><span style="color: #666666">+</span>String(now.minute())<span style="color: #666666">+</span><span style="color: #BA2121">&#39;:&#39;</span><span style="color: #666666">+</span>String(now.second());<span style="color: #bbbbbb"></span>
<span style="color: #bbbbbb">    </span><span style="color: #3D7B7B; font-style: italic">//Serial.println(thistime);</span>
<span style="color: #bbbbbb">    </span><span style="color: #008000; font-weight: bold">return</span><span style="color: #bbbbbb"> </span>thistime;<span style="color: #bbbbbb"></span>
}<span style="color: #bbbbbb"></span>
</pre></div>
<p>
<p>
<!-- navigation buttons at the bottom of the page -->
<ul class="pager">

  <li class="previous">
    <a href="ComputerProjects013.html">&larr; Prev</a>
  </li>

  <li class="next">
    <a href="ComputerProjects015.html">Next &rarr;</a>
  </li>
</ul>
<!-- ------------------- end of main content --------------- -->

</div>  <!-- end container -->
<!-- include javascript, jQuery *first* -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>

<!-- Bootstrap footer
<footer>
<a href="http://..."><img width="250" align=right src="http://..."></a>
</footer>
-->


<center style="font-size:80%">
<!-- copyright only on the titlepage -->
</center>


</body>
</html>
    

